"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const param_select_view_1 = require("./param-select-view");
const atom_1 = require("atom");
class ConfigParamStore {
    constructor(state = {}) {
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.saved = state;
        this.plugins = new Map();
    }
    serialize() {
        return this.saved;
    }
    destroy() {
        this.disposables.dispose();
    }
    onDidUpdate(pluginName, paramName, callback) {
        return this.emitter.on('did-update', (val) => {
            if (val.pluginName === pluginName && val.paramName === paramName) {
                callback(val);
            }
        });
    }
    addParamSpec(pluginName, paramName, spec) {
        let pluginConfig = this.plugins.get(pluginName);
        if (!pluginConfig) {
            pluginConfig = new Map();
            this.plugins.set(pluginName, pluginConfig);
        }
        if (pluginConfig.has(paramName)) {
            throw new Error(`Parameter ${pluginName}.${paramName} already defined!`);
        }
        let value = this.saved[`${pluginName}.${paramName}`];
        if (value === undefined) {
            value = spec.default;
        }
        pluginConfig.set(paramName, { spec, value });
        this.emitter.emit('did-update', { pluginName, paramName, value });
        return new atom_1.Disposable(() => {
            if (pluginConfig) {
                pluginConfig.delete(paramName);
                if (pluginConfig.size === 0) {
                    this.plugins.delete(pluginName);
                }
            }
        });
    }
    async setValue(pluginName, paramName, value) {
        const paramConfig = await this.getParamConfig(pluginName, paramName, 'set');
        if (paramConfig === undefined)
            return undefined;
        if (value === undefined) {
            value = await this.showSelect(paramConfig);
        }
        if (value !== undefined) {
            paramConfig.value = value;
            this.saved[`${pluginName}.${paramName}`] = value;
            this.emitter.emit('did-update', { pluginName, paramName, value });
        }
        return value;
    }
    async getValue(pluginName, paramName) {
        const paramConfig = await this.getParamConfig(pluginName, paramName, 'get');
        if (paramConfig === undefined)
            return undefined;
        if (paramConfig.value === undefined) {
            await this.setValue(pluginName, paramName);
        }
        return paramConfig.value;
    }
    async getValueRaw(pluginName, paramName) {
        const paramConfig = await this.getParamConfig(pluginName, paramName, 'get raw');
        if (paramConfig === undefined)
            return undefined;
        return paramConfig.value;
    }
    async getParamConfig(pluginName, paramName, reason) {
        if (!atom.packages.isPackageLoaded(pluginName)) {
            console.error(new Error(`No ${pluginName} package while trying to ${reason} ${pluginName}.${paramName}`));
            return undefined;
        }
        if (!atom.packages.isPackageActive(pluginName)) {
            await atom.packages.activatePackage(pluginName);
        }
        const pluginConfig = this.plugins.get(pluginName);
        if (!pluginConfig) {
            throw new Error(`${pluginName} is not defined while trying to ${reason} ${pluginName}.${paramName}`);
        }
        const paramConfig = pluginConfig.get(paramName);
        if (!paramConfig) {
            throw new Error(`${paramName} is not defined while trying to ${reason} ${pluginName}.${paramName}`);
        }
        return paramConfig;
    }
    async showSelect(param) {
        const spec = param.spec;
        return param_select_view_1.selectListView({
            items: typeof spec.items === 'function' ? spec.items() : spec.items,
            heading: spec.description,
            itemTemplate: spec.itemTemplate.bind(spec),
            itemFilterKey: spec.itemFilterKey,
            activeItem: param.value,
        });
    }
}
exports.ConfigParamStore = ConfigParamStore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyYW0tc3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29uZmlnLXBhcmFtcy9wYXJhbS1zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJEQUFvRDtBQUNwRCwrQkFBK0Q7QUFtQi9ELE1BQWEsZ0JBQWdCO0lBVTNCLFlBQVksUUFBZ0IsRUFBRTtRQUM1QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2xDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ2xCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtJQUMxQixDQUFDO0lBRU0sU0FBUztRQUNkLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQTtJQUNuQixDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDNUIsQ0FBQztJQUVNLFdBQVcsQ0FDaEIsVUFBa0IsRUFDbEIsU0FBaUIsRUFDakIsUUFBNkI7UUFFN0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUMzQyxJQUFJLEdBQUcsQ0FBQyxVQUFVLEtBQUssVUFBVSxJQUFJLEdBQUcsQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUFFO2dCQUNoRSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7YUFDZDtRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVNLFlBQVksQ0FDakIsVUFBa0IsRUFDbEIsU0FBaUIsRUFDakIsSUFBdUI7UUFFdkIsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtZQUN4QixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsWUFBWSxDQUFDLENBQUE7U0FDM0M7UUFDRCxJQUFJLFlBQVksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLFVBQVUsSUFBSSxTQUFTLG1CQUFtQixDQUFDLENBQUE7U0FDekU7UUFDRCxJQUFJLEtBQUssR0FBa0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsSUFBSSxTQUFTLEVBQUUsQ0FBTSxDQUFBO1FBQ3hFLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUN2QixLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQTtTQUNyQjtRQUNELFlBQVksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7UUFDNUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1FBQ2pFLE9BQU8sSUFBSSxpQkFBVSxDQUFDLEdBQUcsRUFBRTtZQUN6QixJQUFJLFlBQVksRUFBRTtnQkFDaEIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtnQkFDOUIsSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRTtvQkFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7aUJBQ2hDO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFTSxLQUFLLENBQUMsUUFBUSxDQUNuQixVQUFrQixFQUNsQixTQUFpQixFQUNqQixLQUFTO1FBRVQsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUMzQyxVQUFVLEVBQ1YsU0FBUyxFQUNULEtBQUssQ0FDTixDQUFBO1FBQ0QsSUFBSSxXQUFXLEtBQUssU0FBUztZQUFFLE9BQU8sU0FBUyxDQUFBO1FBQy9DLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUN2QixLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFJLFdBQVcsQ0FBQyxDQUFBO1NBQzlDO1FBQ0QsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFO1lBQ3ZCLFdBQVcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1lBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxVQUFVLElBQUksU0FBUyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUE7WUFDaEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1NBQ2xFO1FBQ0QsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQVEsQ0FDbkIsVUFBa0IsRUFDbEIsU0FBaUI7UUFFakIsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUMzQyxVQUFVLEVBQ1YsU0FBUyxFQUNULEtBQUssQ0FDTixDQUFBO1FBQ0QsSUFBSSxXQUFXLEtBQUssU0FBUztZQUFFLE9BQU8sU0FBUyxDQUFBO1FBQy9DLElBQUksV0FBVyxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDbkMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsQ0FBQTtTQUMzQztRQUNELE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQTtJQUMxQixDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FDdEIsVUFBa0IsRUFDbEIsU0FBaUI7UUFFakIsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUMzQyxVQUFVLEVBQ1YsU0FBUyxFQUNULFNBQVMsQ0FDVixDQUFBO1FBQ0QsSUFBSSxXQUFXLEtBQUssU0FBUztZQUFFLE9BQU8sU0FBUyxDQUFBO1FBQy9DLE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQTtJQUMxQixDQUFDO0lBRU8sS0FBSyxDQUFDLGNBQWMsQ0FDMUIsVUFBa0IsRUFDbEIsU0FBaUIsRUFDakIsTUFBYztRQUVkLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUM5QyxPQUFPLENBQUMsS0FBSyxDQUNYLElBQUksS0FBSyxDQUNQLE1BQU0sVUFBVSw0QkFBNEIsTUFBTSxJQUFJLFVBQVUsSUFBSSxTQUFTLEVBQUUsQ0FDaEYsQ0FDRixDQUFBO1lBQ0QsT0FBTyxTQUFTLENBQUE7U0FDakI7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDOUMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQTtTQUNoRDtRQUNELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FDYixHQUFHLFVBQVUsbUNBQW1DLE1BQU0sSUFBSSxVQUFVLElBQUksU0FBUyxFQUFFLENBQ3BGLENBQUE7U0FDRjtRQUNELE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNoQixNQUFNLElBQUksS0FBSyxDQUNiLEdBQUcsU0FBUyxtQ0FBbUMsTUFBTSxJQUFJLFVBQVUsSUFBSSxTQUFTLEVBQUUsQ0FDbkYsQ0FBQTtTQUNGO1FBQ0QsT0FBTyxXQUFXLENBQUE7SUFDcEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxVQUFVLENBQUksS0FBb0I7UUFDOUMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQTtRQUN2QixPQUFPLGtDQUFjLENBQUk7WUFDdkIsS0FBSyxFQUFFLE9BQU8sSUFBSSxDQUFDLEtBQUssS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUs7WUFDbkUsT0FBTyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQ3pCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDMUMsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhO1lBQ2pDLFVBQVUsRUFBRSxLQUFLLENBQUMsS0FBSztTQUN4QixDQUFDLENBQUE7SUFDSixDQUFDO0NBQ0Y7QUEvSkQsNENBK0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2VsZWN0TGlzdFZpZXcgfSBmcm9tICcuL3BhcmFtLXNlbGVjdC12aWV3J1xuaW1wb3J0IHsgRW1pdHRlciwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcblxuaW50ZXJmYWNlIElQYXJhbURhdGE8VD4ge1xuICBzcGVjOiBVUEkuSVBhcmFtU3BlYzxUPlxuICB2YWx1ZT86IFRcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBbcGx1Z2luTmFtZVBhcmFtTmFtZTogc3RyaW5nXTogT2JqZWN0XG59XG5cbmludGVyZmFjZSBUVXBkYXRlZENhbGxiYWNrQXJnPFQ+IHtcbiAgcGx1Z2luTmFtZTogc3RyaW5nXG4gIHBhcmFtTmFtZTogc3RyaW5nXG4gIHZhbHVlOiBUIHwgdW5kZWZpbmVkXG59XG5leHBvcnQgdHlwZSBUVXBkYXRlZENhbGxiYWNrPFQ+ID0gKGFyZzogVFVwZGF0ZWRDYWxsYmFja0FyZzxUPikgPT4gdm9pZFxuXG5leHBvcnQgY2xhc3MgQ29uZmlnUGFyYW1TdG9yZSB7XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBlbWl0dGVyOiBFbWl0dGVyPFxuICAgIHt9LFxuICAgIHtcbiAgICAgICdkaWQtdXBkYXRlJzogeyBwbHVnaW5OYW1lOiBzdHJpbmc7IHBhcmFtTmFtZTogc3RyaW5nOyB2YWx1ZTogYW55IH1cbiAgICB9XG4gID5cbiAgcHJpdmF0ZSBzYXZlZDogSVN0YXRlXG4gIHByaXZhdGUgcGx1Z2luczogTWFwPHN0cmluZywgTWFwPHN0cmluZywgSVBhcmFtRGF0YTxhbnk+Pj5cbiAgY29uc3RydWN0b3Ioc3RhdGU6IElTdGF0ZSA9IHt9KSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuICAgIHRoaXMuc2F2ZWQgPSBzdGF0ZVxuICAgIHRoaXMucGx1Z2lucyA9IG5ldyBNYXAoKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zYXZlZFxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFVwZGF0ZTxUPihcbiAgICBwbHVnaW5OYW1lOiBzdHJpbmcsXG4gICAgcGFyYW1OYW1lOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6IFRVcGRhdGVkQ2FsbGJhY2s8VD4sXG4gICkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC11cGRhdGUnLCAodmFsKSA9PiB7XG4gICAgICBpZiAodmFsLnBsdWdpbk5hbWUgPT09IHBsdWdpbk5hbWUgJiYgdmFsLnBhcmFtTmFtZSA9PT0gcGFyYW1OYW1lKSB7XG4gICAgICAgIGNhbGxiYWNrKHZhbClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFkZFBhcmFtU3BlYzxUPihcbiAgICBwbHVnaW5OYW1lOiBzdHJpbmcsXG4gICAgcGFyYW1OYW1lOiBzdHJpbmcsXG4gICAgc3BlYzogVVBJLklQYXJhbVNwZWM8VD4sXG4gICkge1xuICAgIGxldCBwbHVnaW5Db25maWcgPSB0aGlzLnBsdWdpbnMuZ2V0KHBsdWdpbk5hbWUpXG4gICAgaWYgKCFwbHVnaW5Db25maWcpIHtcbiAgICAgIHBsdWdpbkNvbmZpZyA9IG5ldyBNYXAoKVxuICAgICAgdGhpcy5wbHVnaW5zLnNldChwbHVnaW5OYW1lLCBwbHVnaW5Db25maWcpXG4gICAgfVxuICAgIGlmIChwbHVnaW5Db25maWcuaGFzKHBhcmFtTmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUGFyYW1ldGVyICR7cGx1Z2luTmFtZX0uJHtwYXJhbU5hbWV9IGFscmVhZHkgZGVmaW5lZCFgKVxuICAgIH1cbiAgICBsZXQgdmFsdWU6IFQgfCB1bmRlZmluZWQgPSB0aGlzLnNhdmVkW2Ake3BsdWdpbk5hbWV9LiR7cGFyYW1OYW1lfWBdIGFzIFRcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSBzcGVjLmRlZmF1bHRcbiAgICB9XG4gICAgcGx1Z2luQ29uZmlnLnNldChwYXJhbU5hbWUsIHsgc3BlYywgdmFsdWUgfSlcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXVwZGF0ZScsIHsgcGx1Z2luTmFtZSwgcGFyYW1OYW1lLCB2YWx1ZSB9KVxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICBpZiAocGx1Z2luQ29uZmlnKSB7XG4gICAgICAgIHBsdWdpbkNvbmZpZy5kZWxldGUocGFyYW1OYW1lKVxuICAgICAgICBpZiAocGx1Z2luQ29uZmlnLnNpemUgPT09IDApIHtcbiAgICAgICAgICB0aGlzLnBsdWdpbnMuZGVsZXRlKHBsdWdpbk5hbWUpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNldFZhbHVlPFQ+KFxuICAgIHBsdWdpbk5hbWU6IHN0cmluZyxcbiAgICBwYXJhbU5hbWU6IHN0cmluZyxcbiAgICB2YWx1ZT86IFQsXG4gICk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHBhcmFtQ29uZmlnID0gYXdhaXQgdGhpcy5nZXRQYXJhbUNvbmZpZzxUPihcbiAgICAgIHBsdWdpbk5hbWUsXG4gICAgICBwYXJhbU5hbWUsXG4gICAgICAnc2V0JyxcbiAgICApXG4gICAgaWYgKHBhcmFtQ29uZmlnID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWRcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSBhd2FpdCB0aGlzLnNob3dTZWxlY3Q8VD4ocGFyYW1Db25maWcpXG4gICAgfVxuICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXJhbUNvbmZpZy52YWx1ZSA9IHZhbHVlXG4gICAgICB0aGlzLnNhdmVkW2Ake3BsdWdpbk5hbWV9LiR7cGFyYW1OYW1lfWBdID0gdmFsdWVcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtdXBkYXRlJywgeyBwbHVnaW5OYW1lLCBwYXJhbU5hbWUsIHZhbHVlIH0pXG4gICAgfVxuICAgIHJldHVybiB2YWx1ZVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFZhbHVlPFQ+KFxuICAgIHBsdWdpbk5hbWU6IHN0cmluZyxcbiAgICBwYXJhbU5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcGFyYW1Db25maWcgPSBhd2FpdCB0aGlzLmdldFBhcmFtQ29uZmlnPFQ+KFxuICAgICAgcGx1Z2luTmFtZSxcbiAgICAgIHBhcmFtTmFtZSxcbiAgICAgICdnZXQnLFxuICAgIClcbiAgICBpZiAocGFyYW1Db25maWcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIGlmIChwYXJhbUNvbmZpZy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFZhbHVlKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSlcbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtQ29uZmlnLnZhbHVlXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWVSYXc8VD4oXG4gICAgcGx1Z2luTmFtZTogc3RyaW5nLFxuICAgIHBhcmFtTmFtZTogc3RyaW5nLFxuICApOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBwYXJhbUNvbmZpZyA9IGF3YWl0IHRoaXMuZ2V0UGFyYW1Db25maWc8VD4oXG4gICAgICBwbHVnaW5OYW1lLFxuICAgICAgcGFyYW1OYW1lLFxuICAgICAgJ2dldCByYXcnLFxuICAgIClcbiAgICBpZiAocGFyYW1Db25maWcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZFxuICAgIHJldHVybiBwYXJhbUNvbmZpZy52YWx1ZVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRQYXJhbUNvbmZpZzxUPihcbiAgICBwbHVnaW5OYW1lOiBzdHJpbmcsXG4gICAgcGFyYW1OYW1lOiBzdHJpbmcsXG4gICAgcmVhc29uOiBzdHJpbmcsXG4gICk6IFByb21pc2U8SVBhcmFtRGF0YTxUPiB8IHVuZGVmaW5lZD4ge1xuICAgIGlmICghYXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VMb2FkZWQocGx1Z2luTmFtZSkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgICBgTm8gJHtwbHVnaW5OYW1lfSBwYWNrYWdlIHdoaWxlIHRyeWluZyB0byAke3JlYXNvbn0gJHtwbHVnaW5OYW1lfS4ke3BhcmFtTmFtZX1gLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICBpZiAoIWF0b20ucGFja2FnZXMuaXNQYWNrYWdlQWN0aXZlKHBsdWdpbk5hbWUpKSB7XG4gICAgICBhd2FpdCBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZShwbHVnaW5OYW1lKVxuICAgIH1cbiAgICBjb25zdCBwbHVnaW5Db25maWcgPSB0aGlzLnBsdWdpbnMuZ2V0KHBsdWdpbk5hbWUpXG4gICAgaWYgKCFwbHVnaW5Db25maWcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYCR7cGx1Z2luTmFtZX0gaXMgbm90IGRlZmluZWQgd2hpbGUgdHJ5aW5nIHRvICR7cmVhc29ufSAke3BsdWdpbk5hbWV9LiR7cGFyYW1OYW1lfWAsXG4gICAgICApXG4gICAgfVxuICAgIGNvbnN0IHBhcmFtQ29uZmlnID0gcGx1Z2luQ29uZmlnLmdldChwYXJhbU5hbWUpXG4gICAgaWYgKCFwYXJhbUNvbmZpZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgJHtwYXJhbU5hbWV9IGlzIG5vdCBkZWZpbmVkIHdoaWxlIHRyeWluZyB0byAke3JlYXNvbn0gJHtwbHVnaW5OYW1lfS4ke3BhcmFtTmFtZX1gLFxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gcGFyYW1Db25maWdcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2hvd1NlbGVjdDxUPihwYXJhbTogSVBhcmFtRGF0YTxUPik6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHNwZWMgPSBwYXJhbS5zcGVjXG4gICAgcmV0dXJuIHNlbGVjdExpc3RWaWV3PFQ+KHtcbiAgICAgIGl0ZW1zOiB0eXBlb2Ygc3BlYy5pdGVtcyA9PT0gJ2Z1bmN0aW9uJyA/IHNwZWMuaXRlbXMoKSA6IHNwZWMuaXRlbXMsXG4gICAgICBoZWFkaW5nOiBzcGVjLmRlc2NyaXB0aW9uLFxuICAgICAgaXRlbVRlbXBsYXRlOiBzcGVjLml0ZW1UZW1wbGF0ZS5iaW5kKHNwZWMpLFxuICAgICAgaXRlbUZpbHRlcktleTogc3BlYy5pdGVtRmlsdGVyS2V5LFxuICAgICAgYWN0aXZlSXRlbTogcGFyYW0udmFsdWUsXG4gICAgfSlcbiAgfVxufVxuIl19