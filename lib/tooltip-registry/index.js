"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
class TooltipRegistry {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
        this.providers = [];
    }
    dispose() {
        this.providers = [];
    }
    register(pluginName, provider) {
        const idx = this.providers.findIndex(({ priority }) => priority < provider.priority);
        const defaultEvT = [
            "selection",
            "mouse",
        ];
        const record = {
            pluginName,
            eventTypes: provider.eventTypes ? provider.eventTypes : defaultEvT,
            priority: provider.priority,
            handler: provider.handler,
        };
        if (idx === -1) {
            this.providers.push(record);
        }
        else {
            this.providers.splice(idx, 0, record);
        }
        return new atom_1.Disposable(() => {
            const ix = this.providers.indexOf(record);
            this.providers.splice(ix, 1);
        });
    }
    async showTooltip(editor, type, spec) {
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        let pluginName;
        let tooltipData;
        if (spec && typeof spec.tooltip !== 'function') {
            tooltipData = spec.tooltip;
            pluginName = spec.pluginName;
        }
        else {
            const eventRange = controller.getEventRange(type);
            if (!eventRange) {
                return;
            }
            if (spec && typeof spec.tooltip === 'function') {
                pluginName = spec.pluginName;
                const awaiter = this.pluginManager.getAwaiter(pluginName);
                const tt = spec.tooltip;
                const tooltipDataTemp = await awaiter(() => tt(eventRange.crange));
                if (tooltipDataTemp === undefined)
                    return;
                tooltipData = tooltipDataTemp;
            }
            else {
                const tooltip = await this.defaultTooltipFunction(editor, type, eventRange.crange);
                if (!tooltip) {
                    controller.tooltips.hide(type, undefined, { persistent: false });
                    return;
                }
                ;
                ({ pluginName, tooltipData } = tooltip);
            }
            const newEventRange = controller.getEventRange(type);
            if (!newEventRange || !eventRange.crange.isEqual(newEventRange.crange)) {
                return;
            }
        }
        const { persistent = false } = tooltipData;
        let msg;
        if (Array.isArray(tooltipData.text)) {
            msg = tooltipData.text.map(utils_1.MessageObject.fromObject);
        }
        else {
            msg = utils_1.MessageObject.fromObject(tooltipData.text);
        }
        controller.tooltips.show(atom_1.Range.fromObject(tooltipData.range), msg, type, pluginName, { persistent });
    }
    hideTooltip(editor, type, source) {
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        controller.tooltips.hide(type, source);
    }
    async defaultTooltipFunction(editor, type, crange) {
        for (const { pluginName, handler, eventTypes } of this.providers) {
            if (!eventTypes.includes(type)) {
                continue;
            }
            const awaiter = this.pluginManager.getAwaiter(pluginName);
            const tooltipData = await awaiter(() => handler(editor, crange, type));
            if (tooltipData === undefined)
                continue;
            return { pluginName, tooltipData };
        }
        return undefined;
    }
}
exports.TooltipRegistry = TooltipRegistry;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdG9vbHRpcC1yZWdpc3RyeS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUFxRTtBQUNyRSxvQ0FBd0M7QUE0QnhDLE1BQWEsZUFBZTtJQVExQixZQUFvQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQVB4QyxjQUFTLEdBS2IsRUFBRSxDQUFBO0lBRTZDLENBQUM7SUFFN0MsT0FBTztRQUNaLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFBO0lBQ3JCLENBQUM7SUFFTSxRQUFRLENBQ2IsVUFBa0IsRUFDbEIsUUFBNkI7UUFFN0IsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQ2xDLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQy9DLENBQUE7UUFDRCxNQUFNLFVBQVUsR0FBc0I7OztTQUdyQyxDQUFBO1FBQ0QsTUFBTSxNQUFNLEdBQUc7WUFDYixVQUFVO1lBQ1YsVUFBVSxFQUFFLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFVBQVU7WUFDbEUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRO1lBQzNCLE9BQU8sRUFBRSxRQUFRLENBQUMsT0FBTztTQUMxQixDQUFBO1FBQ0QsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDZCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtTQUM1QjthQUFNO1lBQ0wsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQTtTQUN0QztRQUNELE9BQU8sSUFBSSxpQkFBVSxDQUFDLEdBQUcsRUFBRTtZQUN6QixNQUFNLEVBQUUs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QVUsRUFDVixFQUFFLFVBQVUsRUFBRSxDQUNmLENBQUE7SUFDSCxDQUFDO0lBRU0sV0FBVyxDQUNoQixNQUFrQixFQUNsQixJQUFzQixFQUN0QixNQUFlO1FBRWYsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDeEQsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLE9BQU07U0FDUDtRQUNELFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUN4QyxDQUFDO0lBRU8sS0FBSyxDQUFDLHNCQUFzQixDQUNsQyxNQUFrQixFQUNsQixJQUFxQixFQUNyQixNQUFhO1FBRWIsS0FBSyxNQUFNLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2hFLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM5QixTQUFRO2FBQ1Q7WUFDRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUN6RCxNQUFNLFdBQVcsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1lBQ3RFLElBQUksV0FBVyxLQUFLLFNBQVM7Z0JBQUUsU0FBUTtZQUV2QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxDQUFBO1NBQ25DO1FBQ0QsT0FBTyxTQUFTLENBQUE7SUFDbEIsQ0FBQztDQUNGO0FBcElELDBDQW9JQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IsIERpc3Bvc2FibGUsIFJhbmdlLCBSYW5nZUNvbXBhdGlibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgTWVzc2FnZU9iamVjdCB9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHsgUGx1Z2luTWFuYWdlciB9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgVEV2ZW50UmFuZ2VUeXBlID0gVVBJLlRFdmVudFJhbmdlVHlwZVxuXG5leHBvcnQgaW50ZXJmYWNlIFRUb29sdGlwSGFuZGxlclNwZWMge1xuICBwcmlvcml0eTogbnVtYmVyXG4gIGhhbmRsZXI6IFRUb29sdGlwSGFuZGxlckV4dFxuICBldmVudFR5cGVzPzogVEV2ZW50UmFuZ2VUeXBlW11cbn1cbmV4cG9ydCB0eXBlIFRUb29sdGlwSGFuZGxlckV4dCA9IChcbiAgZWRpdG9yOiBUZXh0RWRpdG9yLFxuICBjcmFuZ2U6IFJhbmdlLFxuICB0eXBlOiBURXZlbnRSYW5nZVR5cGUsXG4pID0+IElUb29sdGlwRGF0YUV4dCB8IHVuZGVmaW5lZCB8IFByb21pc2U8SVRvb2x0aXBEYXRhRXh0IHwgdW5kZWZpbmVkPlxuZXhwb3J0IGludGVyZmFjZSBJVG9vbHRpcFNwZWMge1xuICBwbHVnaW5OYW1lOiBzdHJpbmdcbiAgdG9vbHRpcDogVFRvb2x0aXBGdW5jdGlvbkV4dCB8IElUb29sdGlwRGF0YUV4dFxufVxuZXhwb3J0IHR5cGUgVFRvb2x0aXBGdW5jdGlvbkV4dCA9IChcbiAgY3JhbmdlOiBSYW5nZSxcbikgPT4gSVRvb2x0aXBEYXRhRXh0IHwgUHJvbWlzZTxJVG9vbHRpcERhdGFFeHQ+XG5leHBvcnQgaW50ZXJmYWNlIElUb29sdGlwRGF0YUV4dCB7XG4gIHJhbmdlOiBSYW5nZUNvbXBhdGlibGVcbiAgdGV4dDogVVBJLlRTaW5nbGVPckFycmF5PFVQSS5UTWVzc2FnZSB8IE1lc3NhZ2VPYmplY3Q+XG4gIHBlcnNpc3RlbnQ/OiBib29sZWFuXG59XG5cbmV4cG9ydCBjbGFzcyBUb29sdGlwUmVnaXN0cnkge1xuICBwcml2YXRlIHByb3ZpZGVyczogQXJyYXk8XG4gICAgVFRvb2x0aXBIYW5kbGVyU3BlYyAmIHtcbiAgICAgIHBsdWdpbk5hbWU6IHN0cmluZ1xuICAgICAgZXZlbnRUeXBlczogVEV2ZW50UmFuZ2VUeXBlW11cbiAgICB9XG4gID4gPSBbXVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge31cblxuICBwdWJsaWMgZGlzcG9zZSgpIHtcbiAgICB0aGlzLnByb3ZpZGVycyA9IFtdXG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXIoXG4gICAgcGx1Z2luTmFtZTogc3RyaW5nLFxuICAgIHByb3ZpZGVyOiBUVG9vbHRpcEhhbmRsZXJTcGVjLFxuICApOiBEaXNwb3NhYmxlIHtcbiAgICBjb25zdCBpZHggPSB0aGlzLnByb3ZpZGVycy5maW5kSW5kZXgoXG4gICAgICAoeyBwcmlvcml0eSB9KSA9PiBwcmlvcml0eSA8IHByb3ZpZGVyLnByaW9yaXR5LFxuICAgIClcbiAgICBjb25zdCBkZWZhdWx0RXZUOiBURXZlbnRSYW5nZVR5cGVbXSA9IFtcbiAgICAgIFRFdmVudFJhbmdlVHlwZS5zZWxlY3Rpb24sXG4gICAgICBURXZlbnRSYW5nZVR5cGUubW91c2UsXG4gICAgXVxuICAgIGNvbnN0IHJlY29yZCA9IHtcbiAgICAgIHBsdWdpbk5hbWUsXG4gICAgICBldmVudFR5cGVzOiBwcm92aWRlci5ldmVudFR5cGVzID8gcHJvdmlkZXIuZXZlbnRUeXBlcyA6IGRlZmF1bHRFdlQsXG4gICAgICBwcmlvcml0eTogcHJvdmlkZXIucHJpb3JpdHksXG4gICAgICBoYW5kbGVyOiBwcm92aWRlci5oYW5kbGVyLFxuICAgIH1cbiAgICBpZiAoaWR4ID09PSAtMSkge1xuICAgICAgdGhpcy5wcm92aWRlcnMucHVzaChyZWNvcmQpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJvdmlkZXJzLnNwbGljZShpZHgsIDAsIHJlY29yZClcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIGNvbnN0IGl4ID0gdGhpcy5wcm92aWRlcnMuaW5kZXhPZihyZWNvcmQpXG4gICAgICB0aGlzLnByb3ZpZGVycy5zcGxpY2UoaXgsIDEpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93VG9vbHRpcChcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gICAgdHlwZTogVEV2ZW50UmFuZ2VUeXBlLFxuICAgIHNwZWM/OiBJVG9vbHRpcFNwZWMsXG4gICkge1xuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpXG4gICAgaWYgKCFjb250cm9sbGVyKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgbGV0IHBsdWdpbk5hbWU6IHN0cmluZ1xuICAgIGxldCB0b29sdGlwRGF0YTogVFRvb2x0aXBGdW5jdGlvbkV4dCB8IElUb29sdGlwRGF0YUV4dFxuICAgIGlmIChzcGVjICYmIHR5cGVvZiBzcGVjLnRvb2x0aXAgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRvb2x0aXBEYXRhID0gc3BlYy50b29sdGlwXG4gICAgICBwbHVnaW5OYW1lID0gc3BlYy5wbHVnaW5OYW1lXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGV2ZW50UmFuZ2UgPSBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UodHlwZSlcbiAgICAgIGlmICghZXZlbnRSYW5nZSkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChzcGVjICYmIHR5cGVvZiBzcGVjLnRvb2x0aXAgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcGx1Z2luTmFtZSA9IHNwZWMucGx1Z2luTmFtZVxuICAgICAgICBjb25zdCBhd2FpdGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmdldEF3YWl0ZXIocGx1Z2luTmFtZSlcbiAgICAgICAgY29uc3QgdHQgPSBzcGVjLnRvb2x0aXBcbiAgICAgICAgY29uc3QgdG9vbHRpcERhdGFUZW1wID0gYXdhaXQgYXdhaXRlcigoKSA9PiB0dChldmVudFJhbmdlLmNyYW5nZSkpXG4gICAgICAgIGlmICh0b29sdGlwRGF0YVRlbXAgPT09IHVuZGVmaW5lZCkgcmV0dXJuXG4gICAgICAgIHRvb2x0aXBEYXRhID0gdG9vbHRpcERhdGFUZW1wXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB0b29sdGlwID0gYXdhaXQgdGhpcy5kZWZhdWx0VG9vbHRpcEZ1bmN0aW9uKFxuICAgICAgICAgIGVkaXRvcixcbiAgICAgICAgICB0eXBlLFxuICAgICAgICAgIGV2ZW50UmFuZ2UuY3JhbmdlLFxuICAgICAgICApXG4gICAgICAgIGlmICghdG9vbHRpcCkge1xuICAgICAgICAgIC8vIGlmIG5vYm9keSB3YW50cyB0byBzaG93IGFueXRoaW5nLCBtaWdodCBhcyB3ZWxsIGhpZGUuLi5cbiAgICAgICAgICAvLyBUT0RPOiB0aGlzIGRvZXNuJ3Qgc2VlbSBsaWtlIGEgcGFydGljdWxhcmx5IGJyaWdodCBpZGVhP1xuICAgICAgICAgIGNvbnRyb2xsZXIudG9vbHRpcHMuaGlkZSh0eXBlLCB1bmRlZmluZWQsIHsgcGVyc2lzdGVudDogZmFsc2UgfSlcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICA7KHsgcGx1Z2luTmFtZSwgdG9vbHRpcERhdGEgfSA9IHRvb2x0aXApXG4gICAgICB9XG4gICAgICBjb25zdCBuZXdFdmVudFJhbmdlID0gY29udHJvbGxlci5nZXRFdmVudFJhbmdlKHR5cGUpXG4gICAgICBpZiAoIW5ld0V2ZW50UmFuZ2UgfHwgIWV2ZW50UmFuZ2UuY3JhbmdlLmlzRXF1YWwobmV3RXZlbnRSYW5nZS5jcmFuZ2UpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB7IHBlcnNpc3RlbnQgPSBmYWxzZSB9ID0gdG9vbHRpcERhdGFcbiAgICBsZXQgbXNnXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodG9vbHRpcERhdGEudGV4dCkpIHtcbiAgICAgIG1zZyA9IHRvb2x0aXBEYXRhLnRleHQubWFwKE1lc3NhZ2VPYmplY3QuZnJvbU9iamVjdClcbiAgICB9IGVsc2Uge1xuICAgICAgbXNnID0gTWVzc2FnZU9iamVjdC5mcm9tT2JqZWN0KHRvb2x0aXBEYXRhLnRleHQpXG4gICAgfVxuICAgIGNvbnRyb2xsZXIudG9vbHRpcHMuc2hvdyhcbiAgICAgIFJhbmdlLmZyb21PYmplY3QodG9vbHRpcERhdGEucmFuZ2UpLFxuICAgICAgbXNnLFxuICAgICAgdHlwZSxcbiAgICAgIHBsdWdpbk5hbWUsXG4gICAgICB7IHBlcnNpc3RlbnQgfSxcbiAgICApXG4gIH1cblxuICBwdWJsaWMgaGlkZVRvb2x0aXAoXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yLFxuICAgIHR5cGU/OiBURXZlbnRSYW5nZVR5cGUsXG4gICAgc291cmNlPzogc3RyaW5nLFxuICApIHtcbiAgICBjb25zdCBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnRyb2xsZXIudG9vbHRpcHMuaGlkZSh0eXBlLCBzb3VyY2UpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGRlZmF1bHRUb29sdGlwRnVuY3Rpb24oXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yLFxuICAgIHR5cGU6IFRFdmVudFJhbmdlVHlwZSxcbiAgICBjcmFuZ2U6IFJhbmdlLFxuICApIHtcbiAgICBmb3IgKGNvbnN0IHsgcGx1Z2luTmFtZSwgaGFuZGxlciwgZXZlbnRUeXBlcyB9IG9mIHRoaXMucHJvdmlkZXJzKSB7XG4gICAgICBpZiAoIWV2ZW50VHlwZXMuaW5jbHVkZXModHlwZSkpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGNvbnN0IGF3YWl0ZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuZ2V0QXdhaXRlcihwbHVnaW5OYW1lKVxuICAgICAgY29uc3QgdG9vbHRpcERhdGEgPSBhd2FpdCBhd2FpdGVyKCgpID0+IGhhbmRsZXIoZWRpdG9yLCBjcmFuZ2UsIHR5cGUpKVxuICAgICAgaWYgKHRvb2x0aXBEYXRhID09PSB1bmRlZmluZWQpIGNvbnRpbnVlXG5cbiAgICAgIHJldHVybiB7IHBsdWdpbk5hbWUsIHRvb2x0aXBEYXRhIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG59XG4iXX0=