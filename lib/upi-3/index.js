"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const utils_1 = require("../utils");
tslib_1.__exportStar(require("./instance"), exports);
function consume(pluginManager, options, featureSet) {
    const { name, menu, messageTypes, events, controls, params, tooltip, commands, } = options;
    const disp = new atom_1.CompositeDisposable();
    let messageProvider;
    function registerEvent(cb, reg) {
        if (Array.isArray(cb)) {
            const disp = new atom_1.CompositeDisposable();
            for (const i of cb) {
                disp.add(reg(wrapStatus(i)));
            }
            return disp;
        }
        else {
            return reg(wrapStatus(cb));
        }
    }
    const awaiter = pluginManager.getAwaiter(name);
    function wrapStatus(cb) {
        return function (...args) {
            utils_1.handlePromise(awaiter(() => cb(...args)).then((res) => {
                if (messageProvider && res !== undefined) {
                    messageProvider.setMessages(res);
                }
            }));
        };
    }
    if (menu) {
        const menuDisp = atom.menu.add([
            {
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: menu.label, submenu: menu.menu }],
            },
        ]);
        disp.add(menuDisp);
    }
    if (messageTypes) {
        if (featureSet.eventsReturnResults) {
            messageProvider = pluginManager.resultsDB.registerProvider(Object.keys(messageTypes));
        }
        for (const type of Object.keys(messageTypes)) {
            const opts = messageTypes[type];
            utils_1.handlePromise(pluginManager.outputPanel.createTab(type, opts));
            disp.add(new atom_1.Disposable(function () {
                utils_1.handlePromise(pluginManager.outputPanel.removeTab(type));
            }));
        }
    }
    if (events) {
        if (events.onWillSaveBuffer) {
            disp.add(registerEvent(events.onWillSaveBuffer, pluginManager.onWillSaveBuffer));
        }
        if (events.onDidSaveBuffer) {
            disp.add(registerEvent(events.onDidSaveBuffer, pluginManager.onDidSaveBuffer));
        }
        if (events.onDidStopChanging) {
            disp.add(registerEvent(events.onDidStopChanging, pluginManager.onDidStopChanging));
        }
    }
    if (tooltip) {
        let handler;
        let priority;
        let eventTypes;
        if (typeof tooltip === 'function') {
            handler = tooltip;
        }
        else {
            ;
            ({ handler, priority, eventTypes } = tooltip);
        }
        if (priority === undefined) {
            priority = 100;
        }
        disp.add(pluginManager.tooltipRegistry.register(name, {
            priority,
            handler,
            eventTypes,
        }));
    }
    if (controls) {
        for (const i of controls) {
            disp.add(pluginManager.outputPanel.addPanelControl(i));
        }
    }
    if (params) {
        for (const paramName of Object.keys(params)) {
            const spec = params[paramName];
            disp.add(pluginManager.configParamManager.add(name, paramName, spec));
        }
    }
    if (featureSet.supportsCommands && commands) {
        for (const [target, cmds] of Object.entries(commands)) {
            if (cmds === undefined)
                continue;
            for (const [cmd, handler] of Object.entries(cmds)) {
                disp.add(atom.commands.add(target, cmd, function (event) {
                    wrapStatus(handler)(event.currentTarget);
                }));
            }
        }
    }
    return disp;
}
exports.consume = consume;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQXNEO0FBR3RELG9DQUF5RDtBQUt6RCxxREFBMEI7QUFPMUIsU0FBZ0IsT0FBTyxDQUNyQixhQUE0QixFQUM1QixPQUFpQyxFQUNqQyxVQUFzQjtJQUV0QixNQUFNLEVBQ0osSUFBSSxFQUNKLElBQUksRUFDSixZQUFZLEVBQ1osTUFBTSxFQUNOLFFBQVEsRUFDUixNQUFNLEVBQ04sT0FBTyxFQUNQLFFBQVEsR0FDVCxHQUFHLE9BQU8sQ0FBQTtJQUNYLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxJQUFJLGVBQXFDLENBQUE7SUFFekMsU0FBUyxhQUFhLENBQ3BCLEVBQStDLEVBQy9DLEdBQWdEO1FBRWhELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUNyQixNQUFNLElBQUksR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7WUFDdEMsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDN0I7WUFDRCxPQUFPLElBQUksQ0FBQTtTQUNaO2FBQU07WUFDTCxPQUFPLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtTQUMzQjtJQUNILENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBRTlDLFNBQVMsVUFBVSxDQUNqQixFQUEwRDtRQUUxRCxPQUFPLFVBQVMsR0FBRyxJQUFVO1lBQzNCLHFCQUFhLENBQ1gsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENB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QUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7U0FDdkQ7S0FDRjtJQUNELElBQUksTUFBTSxFQUFFO1FBQ1YsS0FBSyxNQUFNLFNBQVMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzNDLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUM5QixJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1NBQ3RFO0tBQ0Y7SUFDRCxJQUFJLFVBQVUsQ0FBQyxnQkFBZ0IsSUFBSSxRQUFRLEVBQUU7UUFDM0MsS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDckQsSUFBSSxJQUFJLEtBQUssU0FBUztnQkFBRSxTQUFRO1lBQ2hDLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNqRCxJQUFJLENBQUMsR0FBRyxDQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsVUFBUyxLQUFLO29CQUMzQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFBO2dCQUMxQyxDQUFDLENBQUMsQ0FDSCxDQUFBO2FBQ0Y7U0FDRjtLQUNGO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBM0lELDBCQTJJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuXG5pbXBvcnQgeyBQbHVnaW5NYW5hZ2VyIH0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQgeyBNQUlOX01FTlVfTEFCRUwsIGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IFRFdmVudFJhbmdlVHlwZSA9IFVQSS5URXZlbnRSYW5nZVR5cGVcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSAnLi4vcmVzdWx0cy1kYi9wcm92aWRlcidcblxuZXhwb3J0ICogZnJvbSAnLi9pbnN0YW5jZSdcblxuZXhwb3J0IGludGVyZmFjZSBGZWF0dXJlU2V0IHtcbiAgZXZlbnRzUmV0dXJuUmVzdWx0cz86IGJvb2xlYW5cbiAgc3VwcG9ydHNDb21tYW5kcz86IGJvb2xlYW5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWUoXG4gIHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIsXG4gIG9wdGlvbnM6IFVQSS5JUmVnaXN0cmF0aW9uT3B0aW9ucyxcbiAgZmVhdHVyZVNldDogRmVhdHVyZVNldCxcbik6IERpc3Bvc2FibGUge1xuICBjb25zdCB7XG4gICAgbmFtZSxcbiAgICBtZW51LFxuICAgIG1lc3NhZ2VUeXBlcyxcbiAgICBldmVudHMsXG4gICAgY29udHJvbHMsXG4gICAgcGFyYW1zLFxuICAgIHRvb2x0aXAsXG4gICAgY29tbWFuZHMsXG4gIH0gPSBvcHRpb25zXG4gIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIGxldCBtZXNzYWdlUHJvdmlkZXI6IFByb3ZpZGVyIHwgdW5kZWZpbmVkXG5cbiAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudChcbiAgICBjYjogVVBJLlRTaW5nbGVPckFycmF5PFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrPixcbiAgICByZWc6IChjYjogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+IERpc3Bvc2FibGUsXG4gICkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGNiKSkge1xuICAgICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICAgIGZvciAoY29uc3QgaSBvZiBjYikge1xuICAgICAgICBkaXNwLmFkZChyZWcod3JhcFN0YXR1cyhpKSkpXG4gICAgICB9XG4gICAgICByZXR1cm4gZGlzcFxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVnKHdyYXBTdGF0dXMoY2IpKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGF3YWl0ZXIgPSBwbHVnaW5NYW5hZ2VyLmdldEF3YWl0ZXIobmFtZSlcblxuICBmdW5jdGlvbiB3cmFwU3RhdHVzPEFyZ3MgZXh0ZW5kcyBBcnJheTx1bmtub3duPj4oXG4gICAgY2I6ICguLi5hcmdzOiBBcmdzKSA9PiBSZXR1cm5UeXBlPFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrPixcbiAgKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3M6IEFyZ3MpOiB2b2lkIHtcbiAgICAgIGhhbmRsZVByb21pc2UoXG4gICAgICAgIGF3YWl0ZXIoKCkgPT4gY2IoLi4uYXJncykpLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgIGlmIChtZXNzYWdlUHJvdmlkZXIgJiYgcmVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIG1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyhyZXMpXG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBpZiAobWVudSkge1xuICAgIGNvbnN0IG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICAgIHN1Ym1lbnU6IFt7IGxhYmVsOiBtZW51LmxhYmVsLCBzdWJtZW51OiBtZW51Lm1lbnUgfV0sXG4gICAgICB9LFxuICAgIF0pXG4gICAgZGlzcC5hZGQobWVudURpc3ApXG4gIH1cbiAgaWYgKG1lc3NhZ2VUeXBlcykge1xuICAgIGlmIChmZWF0dXJlU2V0LmV2ZW50c1JldHVyblJlc3VsdHMpIHtcbiAgICAgIG1lc3NhZ2VQcm92aWRlciA9IHBsdWdpbk1hbmFnZXIucmVzdWx0c0RCLnJlZ2lzdGVyUHJvdmlkZXIoXG4gICAgICAgIE9iamVjdC5rZXlzKG1lc3NhZ2VUeXBlcyksXG4gICAgICApXG4gICAgfVxuICAgIGZvciAoY29uc3QgdHlwZSBvZiBPYmplY3Qua2V5cyhtZXNzYWdlVHlwZXMpKSB7XG4gICAgICBjb25zdCBvcHRzID0gbWVzc2FnZVR5cGVzW3R5cGVdXG4gICAgICBoYW5kbGVQcm9taXNlKHBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuY3JlYXRlVGFiKHR5cGUsIG9wdHMpKVxuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIG5ldyBEaXNwb3NhYmxlKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGhhbmRsZVByb21pc2UocGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5yZW1vdmVUYWIodHlwZSkpXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgIH1cbiAgfVxuICBpZiAoZXZlbnRzKSB7XG4gICAgaWYgKGV2ZW50cy5vbldpbGxTYXZlQnVmZmVyKSB7XG4gICAgICBkaXNwLmFkZChcbiAgICAgICAgcmVnaXN0ZXJFdmVudChldmVudHMub25XaWxsU2F2ZUJ1ZmZlciwgcGx1Z2luTWFuYWdlci5vbldpbGxTYXZlQnVmZmVyKSxcbiAgICAgIClcbiAgICB9XG4gICAgaWYgKGV2ZW50cy5vbkRpZFNhdmVCdWZmZXIpIHtcbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICByZWdpc3RlckV2ZW50KGV2ZW50cy5vbkRpZFNhdmVCdWZmZXIsIHBsdWdpbk1hbmFnZXIub25EaWRTYXZlQnVmZmVyKSxcbiAgICAgIClcbiAgICB9XG4gICAgaWYgKGV2ZW50cy5vbkRpZFN0b3BDaGFuZ2luZykge1xuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHJlZ2lzdGVyRXZlbnQoXG4gICAgICAgICAgZXZlbnRzLm9uRGlkU3RvcENoYW5naW5nLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICB9XG4gIGlmICh0b29sdGlwKSB7XG4gICAgbGV0IGhhbmRsZXI6IFVQSS5UVG9vbHRpcEhhbmRsZXJcbiAgICBsZXQgcHJpb3JpdHk6IG51bWJlciB8IHVuZGVmaW5lZFxuICAgIGxldCBldmVudFR5cGVzOiBURXZlbnRSYW5nZVR5cGVbXSB8IHVuZGVmaW5lZFxuICAgIGlmICh0eXBlb2YgdG9vbHRpcCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaGFuZGxlciA9IHRvb2x0aXBcbiAgICB9IGVsc2Uge1xuICAgICAgOyh7IGhhbmRsZXIsIHByaW9yaXR5LCBldmVudFR5cGVzIH0gPSB0b29sdGlwKVxuICAgIH1cbiAgICBpZiAocHJpb3JpdHkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcHJpb3JpdHkgPSAxMDBcbiAgICB9XG4gICAgZGlzcC5hZGQoXG4gICAgICBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihuYW1lLCB7XG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBoYW5kbGVyLFxuICAgICAgICBldmVudFR5cGVzLFxuICAgICAgfSksXG4gICAgKVxuICB9XG4gIGlmIChjb250cm9scykge1xuICAgIGZvciAoY29uc3QgaSBvZiBjb250cm9scykge1xuICAgICAgZGlzcC5hZGQocGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woaSkpXG4gICAgfVxuICB9XG4gIGlmIChwYXJhbXMpIHtcbiAgICBmb3IgKGNvbnN0IHBhcmFtTmFtZSBvZiBPYmplY3Qua2V5cyhwYXJhbXMpKSB7XG4gICAgICBjb25zdCBzcGVjID0gcGFyYW1zW3BhcmFtTmFtZV1cbiAgICAgIGRpc3AuYWRkKHBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZChuYW1lLCBwYXJhbU5hbWUsIHNwZWMpKVxuICAgIH1cbiAgfVxuICBpZiAoZmVhdHVyZVNldC5zdXBwb3J0c0NvbW1hbmRzICYmIGNvbW1hbmRzKSB7XG4gICAgZm9yIChjb25zdCBbdGFyZ2V0LCBjbWRzXSBvZiBPYmplY3QuZW50cmllcyhjb21tYW5kcykpIHtcbiAgICAgIGlmIChjbWRzID09PSB1bmRlZmluZWQpIGNvbnRpbnVlXG4gICAgICBmb3IgKGNvbnN0IFtjbWQsIGhhbmRsZXJdIG9mIE9iamVjdC5lbnRyaWVzKGNtZHMpKSB7XG4gICAgICAgIGRpc3AuYWRkKFxuICAgICAgICAgIGF0b20uY29tbWFuZHMuYWRkKHRhcmdldCwgY21kLCBmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgd3JhcFN0YXR1cyhoYW5kbGVyKShldmVudC5jdXJyZW50VGFyZ2V0KVxuICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRpc3Bcbn1cbiJdfQ==