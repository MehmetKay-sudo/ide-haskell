"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const utils_1 = require("../utils");
tslib_1.__exportStar(require("./instance"), exports);
function consume(pluginManager, options, featureSet) {
    const { name, menu, messageTypes, events, controls, params, tooltip, commands, } = options;
    const disp = new atom_1.CompositeDisposable();
    let messageProvider;
    if (menu) {
        const menuDisp = atom.menu.add([
            {
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: menu.label, submenu: menu.menu }],
            },
        ]);
        disp.add(menuDisp);
    }
    if (messageTypes) {
        if (featureSet.eventsReturnResults) {
            messageProvider = pluginManager.resultsDB.registerProvider(Object.keys(messageTypes));
        }
        for (const type of Object.keys(messageTypes)) {
            const opts = messageTypes[type];
            utils_1.handlePromise(pluginManager.outputPanel.createTab(type, opts));
        }
    }
    if (events) {
        if (events.onWillSaveBuffer) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onWillSaveBuffer, pluginManager.onWillSaveBuffer));
        }
        if (events.onDidSaveBuffer) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onDidSaveBuffer, pluginManager.onDidSaveBuffer));
        }
        if (events.onDidStopChanging) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onDidStopChanging, pluginManager.onDidStopChanging));
        }
    }
    if (tooltip) {
        let handler;
        let priority;
        let eventTypes;
        if (typeof tooltip === 'function') {
            handler = tooltip;
        }
        else {
            ;
            ({ handler, priority, eventTypes } = tooltip);
        }
        if (priority === undefined) {
            priority = 100;
        }
        disp.add(pluginManager.tooltipRegistry.register(name, {
            priority,
            handler,
            eventTypes,
        }));
    }
    if (controls) {
        for (const i of controls) {
            disp.add(pluginManager.outputPanel.addPanelControl(i));
        }
    }
    if (params) {
        for (const paramName of Object.keys(params)) {
            const spec = params[paramName];
            disp.add(pluginManager.configParamManager.add(name, paramName, spec));
        }
    }
    if (featureSet.supportsCommands && commands) {
        for (const [target, cmds] of Object.entries(commands)) {
            if (cmds === undefined)
                continue;
            for (const [cmd, handler] of Object.entries(cmds)) {
                disp.add(atom.commands.add(target, cmd, function (event) {
                    wrapStatus(name, pluginManager, messageProvider, handler)(event.currentTarget).catch(function (e) {
                        atom.notifications.addError(e.toString(), {
                            detail: e.message,
                            dismissable: true,
                        });
                    });
                }));
            }
        }
    }
    return disp;
}
exports.consume = consume;
function registerEvent(name, manager, provider, cb, reg) {
    if (Array.isArray(cb)) {
        const disp = new atom_1.CompositeDisposable();
        for (const i of cb) {
            disp.add(reg(wrapStatus(name, manager, provider, i)));
        }
        return disp;
    }
    else {
        return reg(wrapStatus(name, manager, provider, cb));
    }
}
function wrapStatus(name, manager, provider, cb) {
    return async function (...args) {
        try {
            manager.backendStatus(name, { status: 'progress', detail: '' });
            const res = await Promise.resolve(cb(...args));
            if (provider && Array.isArray(res))
                provider.setMessages(res);
            manager.backendStatus(name, { status: 'ready', detail: '' });
        }
        catch (e) {
            manager.backendStatus(name, { status: 'warning', detail: `${e}` });
            console.warn(e);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQXNEO0FBR3RELG9DQUF5RDtBQUt6RCxxREFBMEI7QUFPMUIsU0FBZ0IsT0FBTyxDQUNyQixhQUE0QixFQUM1QixPQUFpQyxFQUNqQyxVQUFzQjtJQUV0QixNQUFNLEVBQ0osSUFBSSxFQUNKLElBQUksRUFDSixZQUFZLEVBQ1osTUFBTSxFQUNOLFFBQVEsRUFDUixNQUFNLEVBQ04sT0FBTyxFQUNQLFFBQVEsR0FDVCxHQUFHLE9BQU8sQ0FBQTtJQUNYLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxJQUFJLGVBQXFDLENBQUE7SUFFekMsSUFBSSxJQUFJLEVBQUU7UUFDUixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUM3QjtnQkFDRSxLQUFLLEVBQUUsdUJBQWU7Z0JBQ3RCLE9BQU8sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQzthQUNyRDtTQUNGLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7S0FDbkI7SUFDRCxJQUFJLFlBQVksRUFBRTtRQUNoQixJQUFJLFVBQVUsQ0FBQyxtQkFBbUIsRUFBRTtZQUNsQyxlQUFlLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FDeEQsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FDMUIsQ0FBQTtTQUNGO1FBQ0QsS0FBSyxNQUFNLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQzVDLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUMvQixxQkFBYSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1NBQy9EO0tBQ0Y7SUFDRCxJQUFJLE1BQU0sRUFBRTtRQUNWLElBQUksTUFBTSxDQUFDLGdCQUFnQixFQUFFO1lBQzNCLElBQUksQ0FBQyxHQUFHLENBQ04sYUFBYSxDQUNYLElBQUksRUFDSixhQUFhLEVBQ2IsZUFBZSxFQUNmLE1BQU0sQ0FBQyxnQkFBZ0IsRUFDdkIsYUFBYSxDQUFDLGdCQUFnQixDQUMvQixDQUNGLENBQUE7U0FDRjtRQUNELElBQUksTUFBTSxDQUFDLGVBQWUsRUFBRTtZQUMxQixJQUFJLENBQUMsR0FBRyxDQUNOLGFBQWEsQ0FDWCxJQUFJLEVBQ0osYUFBYSxFQUNiLGVBQWUsRUFDZixNQUFNLENBQUMsZUFBZSxFQUN0QixhQUFhLENBQUMsZUFBZSxDQUM5QixDQUNGLENBQUE7U0FDRjtRQUNELElBQUksTUFBTSxDQUFDLGlCQUFpQixFQUFFO1lBQzVCLElBQUksQ0FBQyxHQUFHLENBQ04sYUFBYSxDQUNYLElBQUksRUFDSixhQUFhLEVBQ2IsZUFBZSxFQUNmLE1BQU0sQ0FBQyxpQkFBaUIsRUFDeEIsYUFBYSxDQUFDLGlCQUFpQixDQUNoQyxDQUNGLENBQUE7U0FDRjtLQUNGO0lBQ0QsSUFBSSxPQUFPLEVBQUU7UUFDWCxJQUFJLE9BQTRCLENBQUE7UUFDaEMsSUFBSSxRQUE0QixDQUFBO1FBQ2hDLElBQUksVUFBeUMsQ0FBQTtRQUM3QyxJQUFJLE9BQU8sT0FBTyxLQUFLLFVBQVUsRUFBRTtZQUNqQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1NBQ2xCO2FBQU07WUFDTCxDQUFDO1lBQUEsQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLEdBQUcsT0FBTyxDQUFDLENBQUE7U0FDL0M7UUFDRCxJQUFJLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFDMUIsUUFBUSxHQUFHLEdBQUcsQ0FBQTtTQUNmO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FDTixhQUFhLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUU7WUFDM0MsUUFBUTtZQUNSLE9BQU87WUFDUCxVQUFVO1NBQ1gsQ0FBQyxDQUNILENBQUE7S0FDRjtJQUNELElBQUksUUFBUSxFQUFFO1FBQ1osS0FBSyxNQUFNLENBQUMsSUFBSSxRQUFRLEVBQUU7WUFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ3ZEO0tBQ0Y7SUFDRCxJQUFJLE1BQU0sRUFBRTtRQUNWLEtBQUssTUFBTSxTQUFTLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUMzQyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDOUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQTtTQUN0RTtLQUNGO0lBQ0QsSUFBSSxVQUFVLENBQUMsZ0JBQWdCLElBQUksUUFBUSxFQUFFO1FBQzNDLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3JELElBQUksSUFBSSxLQUFLLFNBQVM7Z0JBQUUsU0FBUTtZQUNoQyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDakQsSUFBSSxDQUFDLEdBQUcsQ0FDTixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLFVBQVMsS0FBSztvQkFDM0MsVUFBVSxDQUNSLElBQUksRUFDSixhQUFhLEVBQ2IsZUFBZSxFQUNmLE9BQU8sQ0FDUixDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBUyxDQUFRO3dCQUM1QyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7NEJBQ3hDLE1BQU0sRUFBRSxDQUFDLENBQUMsT0FBTzs0QkFDakIsV0FBVyxFQUFFLElBQUk7eUJBQ2xCLENBQUMsQ0FBQTtvQkFDSixDQUFDLENBQUMsQ0FBQTtnQkFDSixDQUFDLENBQUMsQ0FDSCxDQUFBO2FBQ0Y7U0FDRjtLQUNGO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBaElELDBCQWdJQztBQUVELFNBQVMsYUFBYSxDQUNwQixJQUFZLEVBQ1osT0FBc0IsRUFDdEIsUUFBOEIsRUFDOUIsRUFBK0MsRUFDL0MsR0FBZ0Q7SUFFaEQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN0QyxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNsQixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ3REO1FBQ0QsT0FBTyxJQUFJLENBQUE7S0FDWjtTQUFNO1FBQ0wsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7S0FDcEQ7QUFDSCxDQUFDO0FBRUQsU0FBUyxVQUFVLENBQ2pCLElBQVksRUFDWixPQUFzQixFQUN0QixRQUE4QixFQUM5QixFQUF3QjtJQUV4QixPQUFPLEtBQUssV0FBVSxHQUFHLElBQVU7UUFDakMsSUFBSTtZQUNGLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUMvRCxNQUFNLEdBQUcsR0FBRyxNQUFNLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQTtZQUM5QyxJQUFJLFFBQVEsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztnQkFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQzdELE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtTQUM3RDtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsT0FBTyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUNsRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ2hCO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuXG5pbXBvcnQgeyBQbHVnaW5NYW5hZ2VyIH0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQgeyBNQUlOX01FTlVfTEFCRUwsIGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IFRFdmVudFJhbmdlVHlwZSA9IFVQSS5URXZlbnRSYW5nZVR5cGVcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSAnLi4vcmVzdWx0cy1kYi9wcm92aWRlcidcblxuZXhwb3J0ICogZnJvbSAnLi9pbnN0YW5jZSdcblxuZXhwb3J0IGludGVyZmFjZSBGZWF0dXJlU2V0IHtcbiAgZXZlbnRzUmV0dXJuUmVzdWx0cz86IGJvb2xlYW5cbiAgc3VwcG9ydHNDb21tYW5kcz86IGJvb2xlYW5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWUoXG4gIHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIsXG4gIG9wdGlvbnM6IFVQSS5JUmVnaXN0cmF0aW9uT3B0aW9ucyxcbiAgZmVhdHVyZVNldDogRmVhdHVyZVNldCxcbik6IERpc3Bvc2FibGUge1xuICBjb25zdCB7XG4gICAgbmFtZSxcbiAgICBtZW51LFxuICAgIG1lc3NhZ2VUeXBlcyxcbiAgICBldmVudHMsXG4gICAgY29udHJvbHMsXG4gICAgcGFyYW1zLFxuICAgIHRvb2x0aXAsXG4gICAgY29tbWFuZHMsXG4gIH0gPSBvcHRpb25zXG4gIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIGxldCBtZXNzYWdlUHJvdmlkZXI6IFByb3ZpZGVyIHwgdW5kZWZpbmVkXG5cbiAgaWYgKG1lbnUpIHtcbiAgICBjb25zdCBtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW1xuICAgICAge1xuICAgICAgICBsYWJlbDogTUFJTl9NRU5VX0xBQkVMLFxuICAgICAgICBzdWJtZW51OiBbeyBsYWJlbDogbWVudS5sYWJlbCwgc3VibWVudTogbWVudS5tZW51IH1dLFxuICAgICAgfSxcbiAgICBdKVxuICAgIGRpc3AuYWRkKG1lbnVEaXNwKVxuICB9XG4gIGlmIChtZXNzYWdlVHlwZXMpIHtcbiAgICBpZiAoZmVhdHVyZVNldC5ldmVudHNSZXR1cm5SZXN1bHRzKSB7XG4gICAgICBtZXNzYWdlUHJvdmlkZXIgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQi5yZWdpc3RlclByb3ZpZGVyKFxuICAgICAgICBPYmplY3Qua2V5cyhtZXNzYWdlVHlwZXMpLFxuICAgICAgKVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXMobWVzc2FnZVR5cGVzKSkge1xuICAgICAgY29uc3Qgb3B0cyA9IG1lc3NhZ2VUeXBlc1t0eXBlXVxuICAgICAgaGFuZGxlUHJvbWlzZShwbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmNyZWF0ZVRhYih0eXBlLCBvcHRzKSlcbiAgICB9XG4gIH1cbiAgaWYgKGV2ZW50cykge1xuICAgIGlmIChldmVudHMub25XaWxsU2F2ZUJ1ZmZlcikge1xuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHJlZ2lzdGVyRXZlbnQoXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBwbHVnaW5NYW5hZ2VyLFxuICAgICAgICAgIG1lc3NhZ2VQcm92aWRlcixcbiAgICAgICAgICBldmVudHMub25XaWxsU2F2ZUJ1ZmZlcixcbiAgICAgICAgICBwbHVnaW5NYW5hZ2VyLm9uV2lsbFNhdmVCdWZmZXIsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICAgIGlmIChldmVudHMub25EaWRTYXZlQnVmZmVyKSB7XG4gICAgICBkaXNwLmFkZChcbiAgICAgICAgcmVnaXN0ZXJFdmVudChcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIsXG4gICAgICAgICAgbWVzc2FnZVByb3ZpZGVyLFxuICAgICAgICAgIGV2ZW50cy5vbkRpZFNhdmVCdWZmZXIsXG4gICAgICAgICAgcGx1Z2luTWFuYWdlci5vbkRpZFNhdmVCdWZmZXIsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICAgIGlmIChldmVudHMub25EaWRTdG9wQ2hhbmdpbmcpIHtcbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICByZWdpc3RlckV2ZW50KFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgcGx1Z2luTWFuYWdlcixcbiAgICAgICAgICBtZXNzYWdlUHJvdmlkZXIsXG4gICAgICAgICAgZXZlbnRzLm9uRGlkU3RvcENoYW5naW5nLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICB9XG4gIGlmICh0b29sdGlwKSB7XG4gICAgbGV0IGhhbmRsZXI6IFVQSS5UVG9vbHRpcEhhbmRsZXJcbiAgICBsZXQgcHJpb3JpdHk6IG51bWJlciB8IHVuZGVmaW5lZFxuICAgIGxldCBldmVudFR5cGVzOiBURXZlbnRSYW5nZVR5cGVbXSB8IHVuZGVmaW5lZFxuICAgIGlmICh0eXBlb2YgdG9vbHRpcCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaGFuZGxlciA9IHRvb2x0aXBcbiAgICB9IGVsc2Uge1xuICAgICAgOyh7IGhhbmRsZXIsIHByaW9yaXR5LCBldmVudFR5cGVzIH0gPSB0b29sdGlwKVxuICAgIH1cbiAgICBpZiAocHJpb3JpdHkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcHJpb3JpdHkgPSAxMDBcbiAgICB9XG4gICAgZGlzcC5hZGQoXG4gICAgICBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihuYW1lLCB7XG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBoYW5kbGVyLFxuICAgICAgICBldmVudFR5cGVzLFxuICAgICAgfSksXG4gICAgKVxuICB9XG4gIGlmIChjb250cm9scykge1xuICAgIGZvciAoY29uc3QgaSBvZiBjb250cm9scykge1xuICAgICAgZGlzcC5hZGQocGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woaSkpXG4gICAgfVxuICB9XG4gIGlmIChwYXJhbXMpIHtcbiAgICBmb3IgKGNvbnN0IHBhcmFtTmFtZSBvZiBPYmplY3Qua2V5cyhwYXJhbXMpKSB7XG4gICAgICBjb25zdCBzcGVjID0gcGFyYW1zW3BhcmFtTmFtZV1cbiAgICAgIGRpc3AuYWRkKHBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZChuYW1lLCBwYXJhbU5hbWUsIHNwZWMpKVxuICAgIH1cbiAgfVxuICBpZiAoZmVhdHVyZVNldC5zdXBwb3J0c0NvbW1hbmRzICYmIGNvbW1hbmRzKSB7XG4gICAgZm9yIChjb25zdCBbdGFyZ2V0LCBjbWRzXSBvZiBPYmplY3QuZW50cmllcyhjb21tYW5kcykpIHtcbiAgICAgIGlmIChjbWRzID09PSB1bmRlZmluZWQpIGNvbnRpbnVlXG4gICAgICBmb3IgKGNvbnN0IFtjbWQsIGhhbmRsZXJdIG9mIE9iamVjdC5lbnRyaWVzKGNtZHMpKSB7XG4gICAgICAgIGRpc3AuYWRkKFxuICAgICAgICAgIGF0b20uY29tbWFuZHMuYWRkKHRhcmdldCwgY21kLCBmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgd3JhcFN0YXR1cyhcbiAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgcGx1Z2luTWFuYWdlcixcbiAgICAgICAgICAgICAgbWVzc2FnZVByb3ZpZGVyLFxuICAgICAgICAgICAgICBoYW5kbGVyLFxuICAgICAgICAgICAgKShldmVudC5jdXJyZW50VGFyZ2V0KS5jYXRjaChmdW5jdGlvbihlOiBFcnJvcikge1xuICAgICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZS50b1N0cmluZygpLCB7XG4gICAgICAgICAgICAgICAgZGV0YWlsOiBlLm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGRpc3Bcbn1cblxuZnVuY3Rpb24gcmVnaXN0ZXJFdmVudChcbiAgbmFtZTogc3RyaW5nLFxuICBtYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICBwcm92aWRlcjogUHJvdmlkZXIgfCB1bmRlZmluZWQsXG4gIGNiOiBVUEkuVFNpbmdsZU9yQXJyYXk8VVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2s+LFxuICByZWc6IChjYjogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+IERpc3Bvc2FibGUsXG4pIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkoY2IpKSB7XG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBmb3IgKGNvbnN0IGkgb2YgY2IpIHtcbiAgICAgIGRpc3AuYWRkKHJlZyh3cmFwU3RhdHVzKG5hbWUsIG1hbmFnZXIsIHByb3ZpZGVyLCBpKSkpXG4gICAgfVxuICAgIHJldHVybiBkaXNwXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlZyh3cmFwU3RhdHVzKG5hbWUsIG1hbmFnZXIsIHByb3ZpZGVyLCBjYikpXG4gIH1cbn1cblxuZnVuY3Rpb24gd3JhcFN0YXR1czxBcmdzIGV4dGVuZHMgQXJyYXk8dW5rbm93bj4sIFI+KFxuICBuYW1lOiBzdHJpbmcsXG4gIG1hbmFnZXI6IFBsdWdpbk1hbmFnZXIsXG4gIHByb3ZpZGVyOiBQcm92aWRlciB8IHVuZGVmaW5lZCxcbiAgY2I6ICguLi5hcmdzOiBBcmdzKSA9PiBSLFxuKSB7XG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiguLi5hcmdzOiBBcmdzKSB7XG4gICAgdHJ5IHtcbiAgICAgIG1hbmFnZXIuYmFja2VuZFN0YXR1cyhuYW1lLCB7IHN0YXR1czogJ3Byb2dyZXNzJywgZGV0YWlsOiAnJyB9KVxuICAgICAgY29uc3QgcmVzID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKGNiKC4uLmFyZ3MpKVxuICAgICAgaWYgKHByb3ZpZGVyICYmIEFycmF5LmlzQXJyYXkocmVzKSkgcHJvdmlkZXIuc2V0TWVzc2FnZXMocmVzKVxuICAgICAgbWFuYWdlci5iYWNrZW5kU3RhdHVzKG5hbWUsIHsgc3RhdHVzOiAncmVhZHknLCBkZXRhaWw6ICcnIH0pXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbWFuYWdlci5iYWNrZW5kU3RhdHVzKG5hbWUsIHsgc3RhdHVzOiAnd2FybmluZycsIGRldGFpbDogYCR7ZX1gIH0pXG4gICAgICBjb25zb2xlLndhcm4oZSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==