"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
class CREditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.updateResults = () => {
            const path = this.editor.getPath();
            const resultsToMark = Array.from(this.resultsDB.filter((m) => m.uri === path && m.isValid()));
            const currentMarkers = this.markers.getMarkers();
            const newResults = resultsToMark.filter((r) => currentMarkers.every((m) => this.markerProps.get(m) !== r));
            const markersToDelete = currentMarkers.filter((m) => {
                const p = this.markerProps.get(m);
                return !p || !resultsToMark.includes(p);
            });
            markersToDelete.forEach((m) => m.destroy());
            for (const r of newResults) {
                this.markerFromCheckResult(r);
            }
        };
        const gutter = this.editor.gutterWithName('ide-haskell-check-results');
        if (gutter) {
            this.gutter = gutter;
        }
        else {
            this.gutter = this.editor.addGutter({
                name: 'ide-haskell-check-results',
                priority: 10,
            });
        }
        this.gutterElement = atom.views.getView(this.gutter);
        this.resultsDB = pluginManager.resultsDB;
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.disposables = new atom_1.CompositeDisposable();
        this.markers = editor.addMarkerLayer({
            maintainHistory: true,
            persistent: false,
        });
        this.markerProps = new WeakMap();
        this.disposables.add(this.resultsDB.onDidUpdate(this.updateResults));
        this.updateResults();
        this.registerGutterEvents();
    }
    static supportsGrammar(grammar) {
        return [
            'source.c2hs',
            'source.hsc2hs',
            'source.haskell',
            'text.tex.latex.haskell',
            'source.hsig',
        ].includes(grammar);
    }
    destroy() {
        this.markers.destroy();
        this.disposables.dispose();
        try {
            this.gutter.destroy();
        }
        catch (e) {
            console.warn(e);
        }
    }
    getMessageAt(pos, type) {
        const markers = this.find(pos, type);
        const result = [];
        for (const marker of markers) {
            if (!marker.isValid()) {
                continue;
            }
            const res = this.markerProps.get(marker);
            if (!res) {
                continue;
            }
            result.push(res.message);
        }
        return result;
    }
    registerGutterEvents() {
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseover', '.decoration', (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (bufferPt) {
                const msg = this.getMessageAt(bufferPt, 'gutter');
                if (msg.length > 0) {
                    this.tooltipRegistry.showTooltip(this.editor, "mouse", {
                        pluginName: 'builtin:check-results',
                        tooltip: {
                            text: msg,
                            range: new atom_1.Range(bufferPt, bufferPt),
                        },
                    });
                }
            }
        }));
        this.disposables.add(utils_1.listen(this.gutterElement, 'mouseout', '.decoration', () => this.tooltipRegistry.hideTooltip(this.editor, "mouse", 'builtin:check-results')));
    }
    markerFromCheckResult(resItem) {
        const { position } = resItem;
        if (!position) {
            return;
        }
        const range = new atom_1.Range(position, atom_1.Point.fromObject([position.row, position.column + 1]));
        const marker = this.markers.markBufferRange(range, { invalidate: 'inside' });
        this.markerProps.set(marker, resItem);
        const disp = new atom_1.CompositeDisposable();
        disp.add(marker.onDidDestroy(() => {
            this.markerProps.delete(marker);
            disp.dispose();
        }), marker.onDidChange(({ isValid }) => {
            resItem.setValid(isValid);
        }));
        this.decorateMarker(marker, resItem);
    }
    decorateMarker(m, r) {
        const cls = { class: `ide-haskell-${r.severity}` };
        this.gutter.decorateMarker(m, Object.assign({ type: 'line-number' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'highlight' }, cls));
    }
    find(pos, type) {
        switch (type) {
            case 'gutter':
                return this.markers.findMarkers({ startBufferRow: pos.row });
            case 'keyboard':
                return this.markers.findMarkers({ startBufferPosition: pos });
            case 'mouse':
                return this.markers.findMarkers({ containsBufferPosition: pos });
            default:
                throw new TypeError('Switch assertion failed');
        }
    }
}
exports.CREditorControl = CREditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLWNvbnRyb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2hlY2stcmVzdWx0cy1wcm92aWRlci9lZGl0b3ItY29udHJvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQVFhO0FBTWIsb0NBQThFO0FBRzlFLE1BQWEsZUFBZTtJQVExQixZQUFvQixNQUFrQixFQUFFLGFBQTRCO1FBQWhELFdBQU0sR0FBTixNQUFNLENBQVk7UUFxRzlCLGtCQUFhLEdBQUcsR0FBRyxFQUFFO1lBQzNCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUE7WUFDbEMsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUM1RCxDQUFBO1lBQ0QsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQTtZQUNoRCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDNUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQzNELENBQUE7WUFDRCxNQUFNLGVBQWUsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2xELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNqQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxD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QUFDLEdBQVUsRUFBRSxJQUFnQztRQUN2RCxRQUFRLElBQUksRUFBRTtZQUNaLEtBQUssUUFBUTtnQkFDWCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFBO1lBQzlELEtBQUssVUFBVTtnQkFDYixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUUsbUJBQW1CLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQTtZQUMvRCxLQUFLLE9BQU87Z0JBQ1YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLHNCQUFzQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDbEU7Z0JBQ0UsTUFBTSxJQUFJLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFBO1NBQ2pEO0lBQ0gsQ0FBQztDQUNGO0FBM0tELDBDQTJLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJhbmdlLFxuICBUZXh0RWRpdG9yLFxuICBQb2ludCxcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgR3V0dGVyLFxuICBEaXNwbGF5TWFya2VyLFxuICBEaXNwbGF5TWFya2VyTGF5ZXIsXG59IGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCBURXZlbnRSYW5nZVR5cGUgPSBVUEkuVEV2ZW50UmFuZ2VUeXBlXG5cbmltcG9ydCB7IFJlc3VsdHNEQiwgUmVzdWx0SXRlbSB9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQgeyBQbHVnaW5NYW5hZ2VyLCBJRWRpdG9yQ29udHJvbGxlciB9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHsgbGlzdGVuLCBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50LCBNZXNzYWdlT2JqZWN0IH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgeyBUb29sdGlwUmVnaXN0cnkgfSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuXG5leHBvcnQgY2xhc3MgQ1JFZGl0b3JDb250cm9sIGltcGxlbWVudHMgSUVkaXRvckNvbnRyb2xsZXIge1xuICBwcml2YXRlIGd1dHRlcjogR3V0dGVyXG4gIHByaXZhdGUgZ3V0dGVyRWxlbWVudDogSFRNTEVsZW1lbnRcbiAgcHJpdmF0ZSBtYXJrZXJzOiBEaXNwbGF5TWFya2VyTGF5ZXJcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIG1hcmtlclByb3BzOiBXZWFrTWFwPERpc3BsYXlNYXJrZXIsIFJlc3VsdEl0ZW0+XG4gIHByaXZhdGUgdG9vbHRpcFJlZ2lzdHJ5OiBUb29sdGlwUmVnaXN0cnlcbiAgcHJpdmF0ZSByZXN1bHRzREI6IFJlc3VsdHNEQlxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIGNvbnN0IGd1dHRlciA9IHRoaXMuZWRpdG9yLmd1dHRlcldpdGhOYW1lKCdpZGUtaGFza2VsbC1jaGVjay1yZXN1bHRzJylcbiAgICBpZiAoZ3V0dGVyKSB7XG4gICAgICB0aGlzLmd1dHRlciA9IGd1dHRlclxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmd1dHRlciA9IHRoaXMuZWRpdG9yLmFkZEd1dHRlcih7XG4gICAgICAgIG5hbWU6ICdpZGUtaGFza2VsbC1jaGVjay1yZXN1bHRzJyxcbiAgICAgICAgcHJpb3JpdHk6IDEwLFxuICAgICAgfSlcbiAgICB9XG4gICAgdGhpcy5ndXR0ZXJFbGVtZW50ID0gYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMuZ3V0dGVyKVxuXG4gICAgdGhpcy5yZXN1bHRzREIgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQlxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gcGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5tYXJrZXJzID0gZWRpdG9yLmFkZE1hcmtlckxheWVyKHtcbiAgICAgIG1haW50YWluSGlzdG9yeTogdHJ1ZSxcbiAgICAgIHBlcnNpc3RlbnQ6IGZhbHNlLFxuICAgIH0pXG4gICAgdGhpcy5tYXJrZXJQcm9wcyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnJlc3VsdHNEQi5vbkRpZFVwZGF0ZSh0aGlzLnVwZGF0ZVJlc3VsdHMpKVxuICAgIHRoaXMudXBkYXRlUmVzdWx0cygpXG4gICAgdGhpcy5yZWdpc3Rlckd1dHRlckV2ZW50cygpXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHN1cHBvcnRzR3JhbW1hcihncmFtbWFyOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gW1xuICAgICAgJ3NvdXJjZS5jMmhzJyxcbiAgICAgIC8vICdzb3VyY2UuY2FiYWwnLFxuICAgICAgJ3NvdXJjZS5oc2MyaHMnLFxuICAgICAgJ3NvdXJjZS5oYXNrZWxsJyxcbiAgICAgICd0ZXh0LnRleC5sYXRleC5oYXNrZWxsJyxcbiAgICAgICdzb3VyY2UuaHNpZycsXG4gICAgXS5pbmNsdWRlcyhncmFtbWFyKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5tYXJrZXJzLmRlc3Ryb3koKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuZ3V0dGVyLmRlc3Ryb3koKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICBjb25zb2xlLndhcm4oZSlcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0TWVzc2FnZUF0KHBvczogUG9pbnQsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSB8ICdndXR0ZXInKSB7XG4gICAgY29uc3QgbWFya2VycyA9IHRoaXMuZmluZChwb3MsIHR5cGUpXG4gICAgY29uc3QgcmVzdWx0OiBNZXNzYWdlT2JqZWN0W10gPSBbXVxuICAgIGZvciAoY29uc3QgbWFya2VyIG9mIG1hcmtlcnMpIHtcbiAgICAgIGlmICghbWFya2VyLmlzVmFsaWQoKSkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuICAgICAgY29uc3QgcmVzID0gdGhpcy5tYXJrZXJQcm9wcy5nZXQobWFya2VyKVxuICAgICAgaWYgKCFyZXMpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIHJlc3VsdC5wdXNoKHJlcy5tZXNzYWdlKVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyR3V0dGVyRXZlbnRzKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgbGlzdGVuKHRoaXMuZ3V0dGVyRWxlbWVudCwgJ21vdXNlb3ZlcicsICcuZGVjb3JhdGlvbicsIChlKSA9PiB7XG4gICAgICAgIGNvbnN0IGJ1ZmZlclB0ID0gYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudChcbiAgICAgICAgICB0aGlzLmVkaXRvcixcbiAgICAgICAgICBlIGFzIE1vdXNlRXZlbnQsXG4gICAgICAgIClcbiAgICAgICAgaWYgKGJ1ZmZlclB0KSB7XG4gICAgICAgICAgY29uc3QgbXNnID0gdGhpcy5nZXRNZXNzYWdlQXQoYnVmZmVyUHQsICdndXR0ZXInKVxuICAgICAgICAgIGlmIChtc2cubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgICAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcChcbiAgICAgICAgICAgICAgdGhpcy5lZGl0b3IsXG4gICAgICAgICAgICAgIFRFdmVudFJhbmdlVHlwZS5tb3VzZSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHBsdWdpbk5hbWU6ICdidWlsdGluOmNoZWNrLXJlc3VsdHMnLFxuICAgICAgICAgICAgICAgIHRvb2x0aXA6IHtcbiAgICAgICAgICAgICAgICAgIHRleHQ6IG1zZyxcbiAgICAgICAgICAgICAgICAgIHJhbmdlOiBuZXcgUmFuZ2UoYnVmZmVyUHQsIGJ1ZmZlclB0KSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgbGlzdGVuKHRoaXMuZ3V0dGVyRWxlbWVudCwgJ21vdXNlb3V0JywgJy5kZWNvcmF0aW9uJywgKCkgPT5cbiAgICAgICAgdGhpcy50b29sdGlwUmVnaXN0cnkuaGlkZVRvb2x0aXAoXG4gICAgICAgICAgdGhpcy5lZGl0b3IsXG4gICAgICAgICAgVEV2ZW50UmFuZ2VUeXBlLm1vdXNlLFxuICAgICAgICAgICdidWlsdGluOmNoZWNrLXJlc3VsdHMnLFxuICAgICAgICApLFxuICAgICAgKSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVJlc3VsdHMgPSAoKSA9PiB7XG4gICAgY29uc3QgcGF0aCA9IHRoaXMuZWRpdG9yLmdldFBhdGgoKVxuICAgIGNvbnN0IHJlc3VsdHNUb01hcmsgPSBBcnJheS5mcm9tKFxuICAgICAgdGhpcy5yZXN1bHRzREIuZmlsdGVyKChtKSA9PiBtLnVyaSA9PT0gcGF0aCAmJiBtLmlzVmFsaWQoKSksXG4gICAgKVxuICAgIGNvbnN0IGN1cnJlbnRNYXJrZXJzID0gdGhpcy5tYXJrZXJzLmdldE1hcmtlcnMoKVxuICAgIGNvbnN0IG5ld1Jlc3VsdHMgPSByZXN1bHRzVG9NYXJrLmZpbHRlcigocikgPT5cbiAgICAgIGN1cnJlbnRNYXJrZXJzLmV2ZXJ5KChtKSA9PiB0aGlzLm1hcmtlclByb3BzLmdldChtKSAhPT0gciksXG4gICAgKVxuICAgIGNvbnN0IG1hcmtlcnNUb0RlbGV0ZSA9IGN1cnJlbnRNYXJrZXJzLmZpbHRlcigobSkgPT4ge1xuICAgICAgY29uc3QgcCA9IHRoaXMubWFya2VyUHJvcHMuZ2V0KG0pXG4gICAgICByZXR1cm4gIXAgfHwgIXJlc3VsdHNUb01hcmsuaW5jbHVkZXMocClcbiAgICB9KVxuICAgIG1hcmtlcnNUb0RlbGV0ZS5mb3JFYWNoKChtKSA9PiBtLmRlc3Ryb3koKSlcbiAgICBmb3IgKGNvbnN0IHIgb2YgbmV3UmVzdWx0cykge1xuICAgICAgdGhpcy5tYXJrZXJGcm9tQ2hlY2tSZXN1bHQocilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hcmtlckZyb21DaGVja1Jlc3VsdChyZXNJdGVtOiBSZXN1bHRJdGVtKSB7XG4gICAgY29uc3QgeyBwb3NpdGlvbiB9ID0gcmVzSXRlbVxuICAgIGlmICghcG9zaXRpb24pIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IHJhbmdlID0gbmV3IFJhbmdlKFxuICAgICAgcG9zaXRpb24sXG4gICAgICBQb2ludC5mcm9tT2JqZWN0KFtwb3NpdGlvbi5yb3csIHBvc2l0aW9uLmNvbHVtbiArIDFdKSxcbiAgICApXG4gICAgY29uc3QgbWFya2VyID0gdGhpcy5tYXJrZXJzLm1hcmtCdWZmZXJSYW5nZShyYW5nZSwgeyBpbnZhbGlkYXRlOiAnaW5zaWRlJyB9KVxuICAgIHRoaXMubWFya2VyUHJvcHMuc2V0KG1hcmtlciwgcmVzSXRlbSlcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGRpc3AuYWRkKFxuICAgICAgbWFya2VyLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIHRoaXMubWFya2VyUHJvcHMuZGVsZXRlKG1hcmtlcilcbiAgICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgIH0pLFxuICAgICAgbWFya2VyLm9uRGlkQ2hhbmdlKCh7IGlzVmFsaWQgfTogeyBpc1ZhbGlkOiBib29sZWFuIH0pID0+IHtcbiAgICAgICAgcmVzSXRlbS5zZXRWYWxpZChpc1ZhbGlkKVxuICAgICAgfSksXG4gICAgKVxuICAgIHRoaXMuZGVjb3JhdGVNYXJrZXIobWFya2VyLCByZXNJdGVtKVxuICB9XG5cbiAgcHJpdmF0ZSBkZWNvcmF0ZU1hcmtlcihtOiBEaXNwbGF5TWFya2VyLCByOiBSZXN1bHRJdGVtKSB7XG4gICAgY29uc3QgY2xzID0geyBjbGFzczogYGlkZS1oYXNrZWxsLSR7ci5zZXZlcml0eX1gIH1cbiAgICB0aGlzLmd1dHRlci5kZWNvcmF0ZU1hcmtlcihtLCB7IHR5cGU6ICdsaW5lLW51bWJlcicsIC4uLmNscyB9KVxuICAgIHRoaXMuZWRpdG9yLmRlY29yYXRlTWFya2VyKG0sIHsgdHlwZTogJ2hpZ2hsaWdodCcsIC4uLmNscyB9KVxuICB9XG5cbiAgcHJpdmF0ZSBmaW5kKHBvczogUG9pbnQsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSB8ICdndXR0ZXInKSB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICdndXR0ZXInOlxuICAgICAgICByZXR1cm4gdGhpcy5tYXJrZXJzLmZpbmRNYXJrZXJzKHsgc3RhcnRCdWZmZXJSb3c6IHBvcy5yb3cgfSlcbiAgICAgIGNhc2UgJ2tleWJvYXJkJzpcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2Vycy5maW5kTWFya2Vycyh7IHN0YXJ0QnVmZmVyUG9zaXRpb246IHBvcyB9KVxuICAgICAgY2FzZSAnbW91c2UnOlxuICAgICAgICByZXR1cm4gdGhpcy5tYXJrZXJzLmZpbmRNYXJrZXJzKHsgY29udGFpbnNCdWZmZXJQb3NpdGlvbjogcG9zIH0pXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdTd2l0Y2ggYXNzZXJ0aW9uIGZhaWxlZCcpXG4gICAgfVxuICB9XG59XG4iXX0=