"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = { fileFilter: false, activeTab: 'error' }) {
        this.state = state;
        this.elements = new Set();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.statusMap = new Map();
        this.progress = [];
        this.tabs = new Map();
        this.tabUsers = new Map();
        this.switchFileFilter = () => {
            this.state.fileFilter = !this.state.fileFilter;
            utils_1.handlePromise(this.updateItems());
        };
        this.setButtonsClass(atom.config.get('ide-haskell.buttonsPosition'));
        etch.initialize(this);
        atom.config.onDidChange('ide-haskell.buttonsPosition', ({ newValue }) => {
            this.setButtonsClass(newValue);
            utils_1.handlePromise(this.update());
        });
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            for (const name of OutputPanel.defaultTabs) {
                this.tabs.set(name, {
                    name,
                    count: 0,
                    onClick: () => this.activateTab(name),
                    uriFilter: true,
                    autoScroll: false,
                });
            }
        }
        utils_1.handlePromise(this.update());
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.state.fileFilter)
                utils_1.handlePromise(this.updateItems());
        }));
        setImmediate(async () => {
            await this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        });
    }
    connectResults(results) {
        if (this.results)
            throw new Error('Results already connected!');
        this.results = results;
        let lastUpdateTime = Date.now();
        let collectedSeverities = new Set();
        const didUpdate = (severities) => {
            this.currentResult = 0;
            utils_1.handlePromise(this.updateItems());
            const newUpdateTime = Date.now();
            if (newUpdateTime - lastUpdateTime <
                atom.config.get('ide-haskell.switchTabOnCheckInterval')) {
                for (const s of severities) {
                    collectedSeverities.add(s);
                }
            }
            else {
                collectedSeverities = new Set(severities);
            }
            if (atom.config.get('ide-haskell.autoHideOutput') &&
                (!this.results || this.results.isEmpty(severities))) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab(collectedSeverities);
            }
            lastUpdateTime = newUpdateTime;
        };
        this.disposables.add(this.results.onDidUpdate(didUpdate));
        utils_1.handlePromise(this.update());
    }
    render() {
        if (!this.results) {
            return etch.dom("ide-haskell-panel", null);
        }
        return (etch.dom("ide-haskell-panel", { class: this.buttonsClass },
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { buttons: Array.from(this.tabs.values()), activeBtn: this.state.activeTab }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { class: "ide-haskell-checkbox--uri-filter", state: this.state.fileFilter || false, onSwitched: this.switchFileFilter, enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })));
    }
    async update() {
        return etch.update(this);
    }
    destroy() {
        this.hide();
    }
    async reallyDestroy() {
        await etch.destroy(this);
        this.disposables.dispose();
    }
    async toggle() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (!pane || (utils_1.isDock(pane) && !pane.isVisible())) {
            return this.show();
        }
        else {
            return this.hide();
        }
    }
    async show() {
        await atom.workspace.open(this, {
            searchAllPanes: true,
            activatePane: false,
        });
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            pane.show();
        }
    }
    hide() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            atom.workspace.hide(this);
        }
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getURI() {
        return `ide-haskell://output-panel/`;
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        utils_1.handlePromise(this.update());
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            utils_1.handlePromise(this.update());
        });
    }
    async updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (this.state.fileFilter) {
            const ed = atom.workspace.getActiveTextEditor();
            currentUri = ed ? ed.getPath() : undefined;
        }
        let scroll = false;
        if (activeTab) {
            const ato = this.tabs.get(activeTab);
            if (currentUri !== undefined && ato && ato.uriFilter) {
                this.itemFilter = ({ uri, severity }) => severity === activeTab && uri === currentUri;
            }
            else {
                this.itemFilter = ({ severity }) => severity === activeTab;
            }
            scroll =
                (ato && ato.autoScroll && this.refs.items && this.refs.items.atEnd()) ||
                    false;
        }
        if (this.results) {
            for (const [btn, ato] of this.tabs.entries()) {
                ato.count = Array.from(this.results.filter(({ severity }) => severity === btn)).length;
            }
        }
        await this.update();
        if (scroll && this.refs.items)
            await this.refs.items.scrollToEnd();
    }
    activateTab(tab) {
        this.state.activeTab = tab;
        utils_1.handlePromise(this.updateItems());
    }
    activateFirstNonEmptyTab(severities) {
        for (const tab of this.tabs.values()) {
            if (!severities.has(tab.name))
                continue;
            const count = tab.count;
            if (count && count > 0) {
                utils_1.handlePromise(this.show());
                this.activateTab(tab.name);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        if (this.refs.items)
            utils_1.handlePromise(this.refs.items.showItem(item));
    }
    getActiveTab() {
        return this.state.activeTab;
    }
    async createTab(name, { uriFilter = true, autoScroll = false }) {
        if (OutputPanel.defaultTabs.includes(name))
            return;
        if (this.tabs.has(name)) {
            this.tabUsers.set(name, this.tabUsers.get(name) + 1);
        }
        else {
            this.tabUsers.set(name, 1);
            this.tabs.set(name, {
                name,
                count: 0,
                onClick: () => this.activateTab(name),
                uriFilter,
                autoScroll,
            });
            if (this.state.activeTab)
                this.activateTab(this.state.activeTab);
        }
        return this.update();
    }
    async removeTab(name) {
        if (OutputPanel.defaultTabs.includes(name))
            return;
        if (this.tabUsers.has(name)) {
            let n = this.tabUsers.get(name);
            n -= 1;
            if (n === 0) {
                this.tabUsers.delete(name);
                this.tabs.delete(name);
                if (this.state.activeTab === name) {
                    this.state.activeTab = OutputPanel.defaultTabs[0];
                }
                return this.update();
            }
            else {
                this.tabUsers.set(name, n);
            }
        }
        else {
            throw new Error(`Ide-Haskell: Removing nonexistent output panel tab ${name}`);
        }
    }
    serialize() {
        return Object.assign(Object.assign({}, this.state), { deserializer: 'ide-haskell/OutputPanel' });
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress = Array.from(this.statusMap.values()).reduce((cv, i) => {
            if (i.status === 'progress' && i.progress !== undefined) {
                cv.push(i.progress);
            }
            return cv;
        }, []);
        utils_1.handlePromise(this.update());
    }
    showNextError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => uri !== undefined));
        if (rs.length === 0) {
            return;
        }
        this.currentResult++;
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => uri !== undefined));
        if (rs.length === 0) {
            return;
        }
        this.currentResult--;
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
    setButtonsClass(buttonsPos) {
        switch (buttonsPos) {
            case 'top':
                this.buttonsClass = 'buttons-top';
                break;
            case 'left':
                this.buttonsClass = 'buttons-left';
                break;
        }
    }
}
exports.OutputPanel = OutputPanel;
OutputPanel.defaultTabs = [
    'error',
    'warning',
    'lint',
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE0QjtBQUM1QiwrQkFBc0Q7QUFDdEQsdUVBQTJFO0FBQzNFLHlFQUFtRTtBQUNuRSx1REFBa0Q7QUFDbEQsbUVBQTZEO0FBRTdELHFEQUFnRDtBQUNoRCxvQ0FBb0U7QUFFcEUsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQU9sQixNQUFhLFdBQVc7SUFtQnRCLFlBQ1UsUUFBZ0IsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUU7UUFBekQsVUFBSyxHQUFMLEtBQUssQ0FBb0Q7UUFYM0QsYUFBUSxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ3RDLGdCQUFXLEdBQXdCLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1RCxrQkFBYSxHQUFXLENBQUMsQ0FBQTtRQUN6QixjQUFTLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUE7UUFDL0MsYUFBUSxHQUFhLEVBQUUsQ0FBQTtRQUN2QixTQUFJLEdBQTBCLElBQUksR0FBRyxFQUFFLENBQUE7UUFDdkMsYUFBUSxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBMFZ6QyxxQkFBZ0IsR0FBRyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQTtZQUM5QyxxQkFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFBO1FBQ25DLENBQUMsQ0FBQTtRQXRWQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUMsQ0FBQTtRQUNwRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3JCLElB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ZnJvbSAnZXRjaCdcbmltcG9ydCB7IERpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSUJ0bkRlc2MsIE91dHB1dFBhbmVsQnV0dG9ucyB9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWJ1dHRvbnMnXG5pbXBvcnQgeyBPdXRwdXRQYW5lbENoZWNrYm94IH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtY2hlY2tib3gnXG5pbXBvcnQgeyBQcm9ncmVzc0JhciB9IGZyb20gJy4vdmlld3MvcHJvZ3Jlc3MtYmFyJ1xuaW1wb3J0IHsgT3V0cHV0UGFuZWxJdGVtcyB9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWl0ZW1zJ1xuaW1wb3J0IHsgUmVzdWx0c0RCLCBSZXN1bHRJdGVtIH0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7IFN0YXR1c0ljb24gfSBmcm9tICcuL3ZpZXdzL3N0YXR1cy1pY29uJ1xuaW1wb3J0IHsgaXNEb2NrLCBpc1NpbXBsZUNvbnRyb2xEZWYsIGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuY29uc3QgJCA9IGV0Y2guZG9tXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgZmlsZUZpbHRlcjogYm9vbGVhblxuICBhY3RpdmVUYWI6IHN0cmluZ1xufVxuXG5leHBvcnQgY2xhc3MgT3V0cHV0UGFuZWwge1xuICBwcml2YXRlIHN0YXRpYyBkZWZhdWx0VGFiczogUmVhZG9ubHlBcnJheTxzdHJpbmc+ID0gW1xuICAgICdlcnJvcicsXG4gICAgJ3dhcm5pbmcnLFxuICAgICdsaW50JyxcbiAgXVxuICBwcml2YXRlIHJlZnMhOiB7XG4gICAgaXRlbXM/OiBPdXRwdXRQYW5lbEl0ZW1zXG4gIH1cbiAgcHJpdmF0ZSBlbGVtZW50czogU2V0PEpTWC5FbGVtZW50PiA9IG5ldyBTZXQoKVxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIGN1cnJlbnRSZXN1bHQ6IG51bWJlciA9IDBcbiAgcHJpdmF0ZSBzdGF0dXNNYXA6IE1hcDxzdHJpbmcsIFVQSS5JU3RhdHVzPiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIHByb2dyZXNzOiBudW1iZXJbXSA9IFtdXG4gIHByaXZhdGUgdGFiczogTWFwPHN0cmluZywgSUJ0bkRlc2M+ID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgdGFiVXNlcnM6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKClcbiAgcHJpdmF0ZSBpdGVtRmlsdGVyPzogKGl0ZW06IFJlc3VsdEl0ZW0pID0+IGJvb2xlYW5cbiAgcHJpdmF0ZSByZXN1bHRzPzogUmVzdWx0c0RCXG4gIHByaXZhdGUgYnV0dG9uc0NsYXNzITogJ2J1dHRvbnMtdG9wJyB8ICdidXR0b25zLWxlZnQnXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgc3RhdGU6IElTdGF0ZSA9IHsgZmlsZUZpbHRlcjogZmFsc2UsIGFjdGl2ZVRhYjogJ2Vycm9yJyB9LFxuICApIHtcbiAgICB0aGlzLnNldEJ1dHRvbnNDbGFzcyhhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmJ1dHRvbnNQb3NpdGlvbicpKVxuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuICAgIGF0b20uY29uZmlnLm9uRGlkQ2hhbmdlKCdpZGUtaGFza2VsbC5idXR0b25zUG9zaXRpb24nLCAoeyBuZXdWYWx1ZSB9KSA9PiB7XG4gICAgICB0aGlzLnNldEJ1dHRvbnNDbGFzcyhuZXdWYWx1ZSlcbiAgICAgIGhhbmRsZVByb21pc2UodGhpcy51cGRhdGUoKSlcbiAgICB9KVxuXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBPdXRwdXRQYW5lbC5kZWZhdWx0VGFicykge1xuICAgICAgICB0aGlzLnRhYnMuc2V0KG5hbWUsIHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGNvdW50OiAwLFxuICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHRoaXMuYWN0aXZhdGVUYWIobmFtZSksXG4gICAgICAgICAgdXJpRmlsdGVyOiB0cnVlLFxuICAgICAgICAgIGF1dG9TY3JvbGw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20ud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0oKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5maWxlRmlsdGVyKSBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlSXRlbXMoKSlcbiAgICAgIH0pLFxuICAgIClcbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5zaG93KClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykpIHtcbiAgICAgICAgdGhpcy5oaWRlKClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGNvbm5lY3RSZXN1bHRzKHJlc3VsdHM6IFJlc3VsdHNEQikge1xuICAgIGlmICh0aGlzLnJlc3VsdHMpIHRocm93IG5ldyBFcnJvcignUmVzdWx0cyBhbHJlYWR5IGNvbm5lY3RlZCEnKVxuICAgIHRoaXMucmVzdWx0cyA9IHJlc3VsdHNcblxuICAgIGxldCBsYXN0VXBkYXRlVGltZSA9IERhdGUubm93KClcbiAgICBsZXQgY29sbGVjdGVkU2V2ZXJpdGllcyA9IG5ldyBTZXQ8VVBJLlRTZXZlcml0eT4oKVxuICAgIGNvbnN0IGRpZFVwZGF0ZSA9IChzZXZlcml0aWVzOiBVUEkuVFNldmVyaXR5W10pID0+IHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcblxuICAgICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZUl0ZW1zKCkpXG4gICAgICBjb25zdCBuZXdVcGRhdGVUaW1lID0gRGF0ZS5ub3coKVxuICAgICAgaWYgKFxuICAgICAgICBuZXdVcGRhdGVUaW1lIC0gbGFzdFVwZGF0ZVRpbWUgPFxuICAgICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2tJbnRlcnZhbCcpXG4gICAgICApIHtcbiAgICAgICAgZm9yIChjb25zdCBzIG9mIHNldmVyaXRpZXMpIHtcbiAgICAgICAgICBjb2xsZWN0ZWRTZXZlcml0aWVzLmFkZChzKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2xsZWN0ZWRTZXZlcml0aWVzID0gbmV3IFNldChzZXZlcml0aWVzKVxuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykgJiZcbiAgICAgICAgKCF0aGlzLnJlc3VsdHMgfHwgdGhpcy5yZXN1bHRzLmlzRW1wdHkoc2V2ZXJpdGllcykpXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5oaWRlKClcbiAgICAgIH0gZWxzZSBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5zd2l0Y2hUYWJPbkNoZWNrJykpIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIoY29sbGVjdGVkU2V2ZXJpdGllcylcbiAgICAgIH1cbiAgICAgIGxhc3RVcGRhdGVUaW1lID0gbmV3VXBkYXRlVGltZVxuICAgIH1cblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0cy5vbkRpZFVwZGF0ZShkaWRVcGRhdGUpKVxuXG4gICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZSgpKVxuICB9XG5cbiAgcHVibGljIHJlbmRlcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykge1xuICAgICAgcmV0dXJuIDxpZGUtaGFza2VsbC1wYW5lbCAvPlxuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsIGNsYXNzPXt0aGlzLmJ1dHRvbnNDbGFzc30+XG4gICAgICAgIDxpZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICAgIDxTdGF0dXNJY29uIHN0YXR1c01hcD17dGhpcy5zdGF0dXNNYXB9IC8+XG4gICAgICAgICAgPE91dHB1dFBhbmVsQnV0dG9uc1xuICAgICAgICAgICAgYnV0dG9ucz17QXJyYXkuZnJvbSh0aGlzLnRhYnMudmFsdWVzKCkpfVxuICAgICAgICAgICAgYWN0aXZlQnRuPXt0aGlzLnN0YXRlLmFjdGl2ZVRhYn1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbENoZWNrYm94XG4gICAgICAgICAgICBjbGFzcz1cImlkZS1oYXNrZWxsLWNoZWNrYm94LS11cmktZmlsdGVyXCJcbiAgICAgICAgICAgIHN0YXRlPXt0aGlzLnN0YXRlLmZpbGVGaWx0ZXIgfHwgZmFsc2V9XG4gICAgICAgICAgICBvblN3aXRjaGVkPXt0aGlzLnN3aXRjaEZpbGVGaWx0ZXJ9XG4gICAgICAgICAgICBlbmFibGVkSGludD1cIlNob3cgY3VycmVudCBmaWxlIG1lc3NhZ2VzXCJcbiAgICAgICAgICAgIGRpc2FibGVkSGludD1cIlNob3cgYWxsIHByb2plY3QgbWVzc2FnZXNcIlxuICAgICAgICAgIC8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAgPFByb2dyZXNzQmFyIHByb2dyZXNzPXt0aGlzLnByb2dyZXNzfSAvPlxuICAgICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsLWhlYWRpbmc+XG4gICAgICAgIDxPdXRwdXRQYW5lbEl0ZW1zXG4gICAgICAgICAgbW9kZWw9e3RoaXMucmVzdWx0c31cbiAgICAgICAgICBmaWx0ZXI9e3RoaXMuaXRlbUZpbHRlcn1cbiAgICAgICAgICByZWY9XCJpdGVtc1wiXG4gICAgICAgIC8+XG4gICAgICA8L2lkZS1oYXNrZWxsLXBhbmVsPlxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGUoKSB7XG4gICAgcmV0dXJuIGV0Y2gudXBkYXRlKHRoaXMpXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICB0aGlzLmhpZGUoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlYWxseURlc3Ryb3koKSB7XG4gICAgYXdhaXQgZXRjaC5kZXN0cm95KHRoaXMpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB0b2dnbGUoKSB7XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKCFwYW5lIHx8IChpc0RvY2socGFuZSkgJiYgIXBhbmUuaXNWaXNpYmxlKCkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zaG93KClcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuaGlkZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNob3coKSB7XG4gICAgYXdhaXQgYXRvbS53b3Jrc3BhY2Uub3Blbih0aGlzLCB7XG4gICAgICBzZWFyY2hBbGxQYW5lczogdHJ1ZSxcbiAgICAgIGFjdGl2YXRlUGFuZTogZmFsc2UsXG4gICAgfSlcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAocGFuZSAmJiBpc0RvY2socGFuZSkpIHtcbiAgICAgIHBhbmUuc2hvdygpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhpZGUoKSB7XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKHBhbmUgJiYgaXNEb2NrKHBhbmUpKSB7XG4gICAgICBhdG9tLndvcmtzcGFjZS5oaWRlKHRoaXMpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFRpdGxlKCkge1xuICAgIHJldHVybiAnSURFLUhhc2tlbGwnXG4gIH1cblxuICBwdWJsaWMgZ2V0VVJJKCkge1xuICAgIHJldHVybiBgaWRlLWhhc2tlbGw6Ly9vdXRwdXQtcGFuZWwvYFxuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRMb2NhdGlvbigpIHtcbiAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5wYW5lbFBvc2l0aW9uJylcbiAgfVxuXG4gIHB1YmxpYyBhZGRQYW5lbENvbnRyb2w8VD4oZGVmOiBVUEkuVENvbnRyb2xEZWZpbml0aW9uPFQ+KSB7XG4gICAgbGV0IG5ld0VsZW1lbnQ6IEpTWC5FbGVtZW50XG4gICAgaWYgKGlzU2ltcGxlQ29udHJvbERlZihkZWYpKSB7XG4gICAgICBjb25zdCB7IGV2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzIH0gPSBkZWYub3B0c1xuICAgICAgY29uc3QgcHJvcHM6IHsgW2tleTogc3RyaW5nXTogT2JqZWN0IH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHtcbiAgICAgICAgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKVxuICAgICAgfVxuICAgICAgaWYgKHN0eWxlKSB7XG4gICAgICAgIHByb3BzLnN0eWxlID0gc3R5bGVcbiAgICAgIH1cbiAgICAgIGlmIChhdHRycykge1xuICAgICAgICBwcm9wcy5hdHRyaWJ1dGVzID0gYXR0cnNcbiAgICAgIH1cbiAgICAgIGlmIChldmVudHMpIHtcbiAgICAgICAgcHJvcHMub24gPSBldmVudHNcbiAgICAgIH1cblxuICAgICAgbmV3RWxlbWVudCA9ICQoZGVmLmVsZW1lbnQsIHByb3BzKVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdFbGVtZW50ID0gJChkZWYuZWxlbWVudCwgZGVmLm9wdHMpXG4gICAgfVxuICAgIHRoaXMuZWxlbWVudHMuYWRkKG5ld0VsZW1lbnQpXG5cbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKG5ld0VsZW1lbnQpXG4gICAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVJdGVtcygpIHtcbiAgICBjb25zdCBhY3RpdmVUYWIgPSB0aGlzLmdldEFjdGl2ZVRhYigpXG4gICAgbGV0IGN1cnJlbnRVcmk6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGlmICh0aGlzLnN0YXRlLmZpbGVGaWx0ZXIpIHtcbiAgICAgIGNvbnN0IGVkID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gICAgICBjdXJyZW50VXJpID0gZWQgPyBlZC5nZXRQYXRoKCkgOiB1bmRlZmluZWRcbiAgICB9XG4gICAgbGV0IHNjcm9sbDogYm9vbGVhbiA9IGZhbHNlXG4gICAgaWYgKGFjdGl2ZVRhYikge1xuICAgICAgY29uc3QgYXRvID0gdGhpcy50YWJzLmdldChhY3RpdmVUYWIpXG4gICAgICBpZiAoY3VycmVudFVyaSAhPT0gdW5kZWZpbmVkICYmIGF0byAmJiBhdG8udXJpRmlsdGVyKSB7XG4gICAgICAgIHRoaXMuaXRlbUZpbHRlciA9ICh7IHVyaSwgc2V2ZXJpdHkgfSkgPT5cbiAgICAgICAgICBzZXZlcml0eSA9PT0gYWN0aXZlVGFiICYmIHVyaSA9PT0gY3VycmVudFVyaVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5pdGVtRmlsdGVyID0gKHsgc2V2ZXJpdHkgfSkgPT4gc2V2ZXJpdHkgPT09IGFjdGl2ZVRhYlxuICAgICAgfVxuICAgICAgc2Nyb2xsID1cbiAgICAgICAgKGF0byAmJiBhdG8uYXV0b1Njcm9sbCAmJiB0aGlzLnJlZnMuaXRlbXMgJiYgdGhpcy5yZWZzLml0ZW1zLmF0RW5kKCkpIHx8XG4gICAgICAgIGZhbHNlXG4gICAgfVxuXG4gICAgaWYgKHRoaXMucmVzdWx0cykge1xuICAgICAgZm9yIChjb25zdCBbYnRuLCBhdG9dIG9mIHRoaXMudGFicy5lbnRyaWVzKCkpIHtcbiAgICAgICAgYXRvLmNvdW50ID0gQXJyYXkuZnJvbShcbiAgICAgICAgICB0aGlzLnJlc3VsdHMuZmlsdGVyKCh7IHNldmVyaXR5IH0pID0+IHNldmVyaXR5ID09PSBidG4pLFxuICAgICAgICApLmxlbmd0aFxuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMudXBkYXRlKClcblxuICAgIGlmIChzY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zKSBhd2FpdCB0aGlzLnJlZnMuaXRlbXMuc2Nyb2xsVG9FbmQoKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlVGFiKHRhYjogc3RyaW5nKSB7XG4gICAgdGhpcy5zdGF0ZS5hY3RpdmVUYWIgPSB0YWJcbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlSXRlbXMoKSlcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIoc2V2ZXJpdGllczogU2V0PFVQSS5UU2V2ZXJpdHk+KSB7XG4gICAgZm9yIChjb25zdCB0YWIgb2YgdGhpcy50YWJzLnZhbHVlcygpKSB7XG4gICAgICBpZiAoIXNldmVyaXRpZXMuaGFzKHRhYi5uYW1lKSkgY29udGludWVcbiAgICAgIGNvbnN0IGNvdW50ID0gdGFiLmNvdW50XG4gICAgICBpZiAoY291bnQgJiYgY291bnQgPiAwKSB7XG4gICAgICAgIGhhbmRsZVByb21pc2UodGhpcy5zaG93KCkpXG4gICAgICAgIHRoaXMuYWN0aXZhdGVUYWIodGFiLm5hbWUpXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNob3dJdGVtKGl0ZW06IFJlc3VsdEl0ZW0pIHtcbiAgICB0aGlzLmFjdGl2YXRlVGFiKGl0ZW0uc2V2ZXJpdHkpXG5cbiAgICBpZiAodGhpcy5yZWZzLml0ZW1zKSBoYW5kbGVQcm9taXNlKHRoaXMucmVmcy5pdGVtcy5zaG93SXRlbShpdGVtKSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3RpdmVUYWIoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuYWN0aXZlVGFiXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlVGFiKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB7IHVyaUZpbHRlciA9IHRydWUsIGF1dG9TY3JvbGwgPSBmYWxzZSB9OiBVUEkuSVNldmVyaXR5VGFiRGVmaW5pdGlvbixcbiAgKSB7XG4gICAgaWYgKE91dHB1dFBhbmVsLmRlZmF1bHRUYWJzLmluY2x1ZGVzKG5hbWUpKSByZXR1cm5cbiAgICBpZiAodGhpcy50YWJzLmhhcyhuYW1lKSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIHRoaXMudGFiVXNlcnMuc2V0KG5hbWUsIHRoaXMudGFiVXNlcnMuZ2V0KG5hbWUpISArIDEpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGFiVXNlcnMuc2V0KG5hbWUsIDEpXG4gICAgICB0aGlzLnRhYnMuc2V0KG5hbWUsIHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgY291bnQ6IDAsXG4gICAgICAgIG9uQ2xpY2s6ICgpID0+IHRoaXMuYWN0aXZhdGVUYWIobmFtZSksXG4gICAgICAgIHVyaUZpbHRlcixcbiAgICAgICAgYXV0b1Njcm9sbCxcbiAgICAgIH0pXG4gICAgICBpZiAodGhpcy5zdGF0ZS5hY3RpdmVUYWIpIHRoaXMuYWN0aXZhdGVUYWIodGhpcy5zdGF0ZS5hY3RpdmVUYWIpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVtb3ZlVGFiKG5hbWU6IHN0cmluZykge1xuICAgIGlmIChPdXRwdXRQYW5lbC5kZWZhdWx0VGFicy5pbmNsdWRlcyhuYW1lKSkgcmV0dXJuXG4gICAgaWYgKHRoaXMudGFiVXNlcnMuaGFzKG5hbWUpKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgbGV0IG4gPSB0aGlzLnRhYlVzZXJzLmdldChuYW1lKSFcbiAgICAgIG4gLT0gMVxuICAgICAgaWYgKG4gPT09IDApIHtcbiAgICAgICAgdGhpcy50YWJVc2Vycy5kZWxldGUobmFtZSlcbiAgICAgICAgdGhpcy50YWJzLmRlbGV0ZShuYW1lKVxuICAgICAgICBpZiAodGhpcy5zdGF0ZS5hY3RpdmVUYWIgPT09IG5hbWUpIHtcbiAgICAgICAgICB0aGlzLnN0YXRlLmFjdGl2ZVRhYiA9IE91dHB1dFBhbmVsLmRlZmF1bHRUYWJzWzBdXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlKClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudGFiVXNlcnMuc2V0KG5hbWUsIG4pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYElkZS1IYXNrZWxsOiBSZW1vdmluZyBub25leGlzdGVudCBvdXRwdXQgcGFuZWwgdGFiICR7bmFtZX1gLFxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUoKTogSVN0YXRlICYgeyBkZXNlcmlhbGl6ZXI6ICdpZGUtaGFza2VsbC9PdXRwdXRQYW5lbCcgfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICBkZXNlcmlhbGl6ZXI6ICdpZGUtaGFza2VsbC9PdXRwdXRQYW5lbCcsXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMocGx1Z2luTmFtZTogc3RyaW5nLCBzdDogVVBJLklTdGF0dXMpIHtcbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgdGhpcy5wcm9ncmVzcyA9IEFycmF5LmZyb20odGhpcy5zdGF0dXNNYXAudmFsdWVzKCkpLnJlZHVjZSgoY3YsIGkpID0+IHtcbiAgICAgIGlmIChpLnN0YXR1cyA9PT0gJ3Byb2dyZXNzJyAmJiBpLnByb2dyZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY3YucHVzaChpLnByb2dyZXNzKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGN2XG4gICAgfSwgW10gYXMgbnVtYmVyW10pXG5cbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykgcmV0dXJuXG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHsgdXJpIH0pID0+IHVyaSAhPT0gdW5kZWZpbmVkKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSAwXG4gICAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IoKSB7XG4gICAgaWYgKCF0aGlzLnJlc3VsdHMpIHJldHVyblxuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7IHVyaSB9KSA9PiB1cmkgIT09IHVuZGVmaW5lZCkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gcnMubGVuZ3RoIC0gMVxuICAgIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxuXG4gIHByaXZhdGUgc3dpdGNoRmlsZUZpbHRlciA9ICgpID0+IHtcbiAgICB0aGlzLnN0YXRlLmZpbGVGaWx0ZXIgPSAhdGhpcy5zdGF0ZS5maWxlRmlsdGVyXG4gICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZUl0ZW1zKCkpXG4gIH1cblxuICBwcml2YXRlIHNldEJ1dHRvbnNDbGFzcyhidXR0b25zUG9zOiAndG9wJyB8ICdsZWZ0Jykge1xuICAgIHN3aXRjaCAoYnV0dG9uc1Bvcykge1xuICAgICAgY2FzZSAndG9wJzpcbiAgICAgICAgdGhpcy5idXR0b25zQ2xhc3MgPSAnYnV0dG9ucy10b3AnXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdsZWZ0JzpcbiAgICAgICAgdGhpcy5idXR0b25zQ2xhc3MgPSAnYnV0dG9ucy1sZWZ0J1xuICAgICAgICBicmVha1xuICAgIH1cbiAgfVxufVxuIl19