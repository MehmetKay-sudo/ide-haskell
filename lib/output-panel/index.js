"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const output_panel_items_1 = require("./views/output-panel-items");
const utils_1 = require("../utils");
class OutputPanel {
    constructor(state = { fileFilter: false, activeTab: 'error' }) {
        this.state = state;
        this.elements = new Set();
        this.disposables = new atom_1.CompositeDisposable();
        this.tabs = new Map();
        this.tabUsers = new Map();
        this.currentResult = 0;
        this.switchFileFilter = () => {
            this.state.fileFilter = !this.state.fileFilter;
            utils_1.handlePromise(this.updateItems());
        };
        this.setButtonsClass(atom.config.get('ide-haskell.buttonsPosition'));
        etch.initialize(this);
        atom.config.onDidChange('ide-haskell.buttonsPosition', ({ newValue }) => {
            this.setButtonsClass(newValue);
            utils_1.handlePromise(this.update());
        });
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            for (const name of OutputPanel.defaultTabs) {
                this.tabs.set(name, {
                    name,
                    count: 0,
                    onClick: () => this.activateTab(name),
                    uriFilter: true,
                    autoScroll: false,
                });
            }
        }
        utils_1.handlePromise(this.update());
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.state.fileFilter)
                utils_1.handlePromise(this.updateItems());
        }));
        setImmediate(async () => {
            await this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        });
    }
    connectBsc(bsc) {
        if (this.bsc)
            throw new Error('BackendStatusController already connected!');
        this.bsc = bsc;
        this.disposables.add(this.bsc.onDidUpdate(() => utils_1.handlePromise(this.update())));
        utils_1.handlePromise(this.update());
    }
    connectResults(results) {
        if (this.results)
            throw new Error('Results already connected!');
        this.results = results;
        let lastUpdateTime = Date.now();
        let collectedSeverities = new Set();
        const didUpdate = (severities) => {
            this.currentResult = 0;
            utils_1.handlePromise(this.updateItems());
            const newUpdateTime = Date.now();
            if (newUpdateTime - lastUpdateTime <
                atom.config.get('ide-haskell.switchTabOnCheckInterval')) {
                for (const s of severities) {
                    collectedSeverities.add(s);
                }
            }
            else {
                collectedSeverities = new Set(severities);
            }
            if (atom.config.get('ide-haskell.autoHideOutput') &&
                (!this.results || this.results.isEmpty(severities))) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab(collectedSeverities);
            }
            lastUpdateTime = newUpdateTime;
        };
        this.disposables.add(this.results.onDidUpdate(didUpdate));
        utils_1.handlePromise(this.update());
    }
    render() {
        var _a, _b;
        if (!this.results) {
            return etch.dom("ide-haskell-panel", null);
        }
        return (etch.dom("ide-haskell-panel", { class: this.buttonsClass },
            etch.dom("ide-haskell-panel-heading", null,
                ((_a = this.bsc) === null || _a === void 0 ? void 0 : _a.renderStatusIcon()) || null,
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { buttons: Array.from(this.tabs.values()), activeBtn: this.state.activeTab }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { class: "ide-haskell-checkbox--uri-filter", state: this.state.fileFilter || false, onSwitched: this.switchFileFilter, enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                ((_b = this.bsc) === null || _b === void 0 ? void 0 : _b.renderProgressBar()) || null),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })));
    }
    async update() {
        return etch.update(this);
    }
    destroy() {
        this.hide();
    }
    async reallyDestroy() {
        await etch.destroy(this);
        this.disposables.dispose();
    }
    async toggle() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (!pane || (utils_1.isDock(pane) && !pane.isVisible())) {
            return this.show();
        }
        else {
            return this.hide();
        }
    }
    async show() {
        await atom.workspace.open(this, {
            searchAllPanes: true,
            activatePane: false,
        });
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            pane.show();
        }
    }
    hide() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            atom.workspace.hide(this);
        }
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getURI() {
        return `ide-haskell://output-panel/`;
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = etch.dom(def.element, props);
        }
        else {
            newElement = etch.dom(def.element, def.opts);
        }
        this.elements.add(newElement);
        utils_1.handlePromise(this.update());
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            utils_1.handlePromise(this.update());
        });
    }
    async updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (this.state.fileFilter) {
            const ed = atom.workspace.getActiveTextEditor();
            currentUri = ed ? ed.getPath() : undefined;
        }
        let scroll = false;
        if (activeTab) {
            const ato = this.tabs.get(activeTab);
            if (currentUri !== undefined && ato && ato.uriFilter) {
                this.itemFilter = ({ uri, severity }) => severity === activeTab && uri === currentUri;
            }
            else {
                this.itemFilter = ({ severity }) => severity === activeTab;
            }
            scroll =
                (ato && ato.autoScroll && this.refs.items && this.refs.items.atEnd()) ||
                    false;
        }
        if (this.results) {
            for (const [btn, ato] of this.tabs.entries()) {
                ato.count = Array.from(this.results.filter(({ severity }) => severity === btn)).length;
            }
        }
        await this.update();
        if (scroll && this.refs.items)
            await this.refs.items.scrollToEnd();
    }
    activateTab(tab) {
        this.state.activeTab = tab;
        utils_1.handlePromise(this.updateItems());
    }
    activateFirstNonEmptyTab(severities) {
        for (const tab of this.tabs.values()) {
            if (!severities.has(tab.name))
                continue;
            const count = tab.count;
            if (count && count > 0) {
                utils_1.handlePromise(this.show());
                this.activateTab(tab.name);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        if (this.refs.items)
            utils_1.handlePromise(this.refs.items.showItem(item));
    }
    getActiveTab() {
        return this.state.activeTab;
    }
    async createTab(name, { uriFilter = true, autoScroll = false }) {
        if (OutputPanel.defaultTabs.includes(name))
            return;
        if (this.tabs.has(name)) {
            this.tabUsers.set(name, this.tabUsers.get(name) + 1);
        }
        else {
            this.tabUsers.set(name, 1);
            this.tabs.set(name, {
                name,
                count: 0,
                onClick: () => this.activateTab(name),
                uriFilter,
                autoScroll,
            });
            if (this.state.activeTab)
                this.activateTab(this.state.activeTab);
        }
        return this.update();
    }
    async removeTab(name) {
        if (OutputPanel.defaultTabs.includes(name))
            return;
        if (this.tabUsers.has(name)) {
            let n = this.tabUsers.get(name);
            n -= 1;
            if (n === 0) {
                this.tabUsers.delete(name);
                this.tabs.delete(name);
                if (this.state.activeTab === name) {
                    this.state.activeTab = OutputPanel.defaultTabs[0];
                }
                return this.update();
            }
            else {
                this.tabUsers.set(name, n);
            }
        }
        else {
            throw new Error(`Ide-Haskell: Removing nonexistent output panel tab ${name}`);
        }
    }
    serialize() {
        return Object.assign(Object.assign({}, this.state), { deserializer: 'ide-haskell/OutputPanel' });
    }
    showNextError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => uri !== undefined));
        if (rs.length === 0) {
            return;
        }
        this.currentResult++;
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => uri !== undefined));
        if (rs.length === 0) {
            return;
        }
        this.currentResult--;
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
    setButtonsClass(buttonsPos) {
        switch (buttonsPos) {
            case 'top':
                this.buttonsClass = 'buttons-top';
                break;
            case 'left':
                this.buttonsClass = 'buttons-left';
                break;
        }
    }
}
exports.OutputPanel = OutputPanel;
OutputPanel.defaultTabs = [
    'error',
    'warning',
    'lint',
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE0QjtBQUM1QiwrQkFBc0Q7QUFDdEQsdUVBQTJFO0FBQzNFLHlFQUFtRTtBQUNuRSxtRUFBNkQ7QUFFN0Qsb0NBQW9FO0FBU3BFLE1BQWEsV0FBVztJQWtCdEIsWUFDVSxRQUFnQixFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRTtRQUF6RCxVQUFLLEdBQUwsS0FBSyxDQUFvRDtRQVZsRCxhQUFRLEdBQXFCLElBQUksR0FBRyxFQUFFLENBQUE7UUFDdEMsZ0JBQVcsR0FBd0IsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVELFNBQUksR0FBMEIsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUN2QyxhQUFRLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUE7UUFFbEQsa0JBQWEsR0FBVyxDQUFDLENBQUE7UUEwVnpCLHFCQUFnQixHQUFHLEdBQUcsRUFBRTtZQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFBO1lBQzlDLHFCQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUE7UUFDbkMsQ0FBQyxDQUFBO1FBdFZDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQyxDQUFBO1FBQ3BFLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDckIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsNkJBQTZCLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUU7WUFDdEUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUM5QixxQkFBYSxDQUFDLElB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QUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUE7UUFDMUUsSUFBSSxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNuQixPQUFNO1NBQ1A7UUFFRCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDcEIsSUFBSSxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsRUFBRTtZQUMxQixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1NBQ25DO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUE7SUFDdkMsQ0FBQztJQU9PLGVBQWUsQ0FBQyxVQUEwQjtRQUNoRCxRQUFRLFVBQVUsRUFBRTtZQUNsQixLQUFLLEtBQUs7Z0JBQ1IsSUFBSSxDQUFDLFlBQVksR0FBRyxhQUFhLENBQUE7Z0JBQ2pDLE1BQUs7WUFDUCxLQUFLLE1BQU07Z0JBQ1QsSUFBSSxDQUFDLFlBQVksR0FBRyxjQUFjLENBQUE7Z0JBQ2xDLE1BQUs7U0FDUjtJQUNILENBQUM7O0FBdFhILGtDQXVYQztBQXRYeUIsdUJBQVcsR0FBMEI7SUFDM0QsT0FBTztJQUNQLFNBQVM7SUFDVCxNQUFNO0NBQ1AsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV0Y2ggZnJvbSAnZXRjaCdcbmltcG9ydCB7IERpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSUJ0bkRlc2MsIE91dHB1dFBhbmVsQnV0dG9ucyB9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWJ1dHRvbnMnXG5pbXBvcnQgeyBPdXRwdXRQYW5lbENoZWNrYm94IH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtY2hlY2tib3gnXG5pbXBvcnQgeyBPdXRwdXRQYW5lbEl0ZW1zIH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtaXRlbXMnXG5pbXBvcnQgeyBSZXN1bHRzREIsIFJlc3VsdEl0ZW0gfSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHsgaXNEb2NrLCBpc1NpbXBsZUNvbnRyb2xEZWYsIGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IHsgQmFja2VuZFN0YXR1c0NvbnRyb2xsZXIgfSBmcm9tICcuLi9iYWNrZW5kLXN0YXR1cydcblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBmaWxlRmlsdGVyOiBib29sZWFuXG4gIGFjdGl2ZVRhYjogc3RyaW5nXG59XG5cbmV4cG9ydCBjbGFzcyBPdXRwdXRQYW5lbCB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGRlZmF1bHRUYWJzOiBSZWFkb25seUFycmF5PHN0cmluZz4gPSBbXG4gICAgJ2Vycm9yJyxcbiAgICAnd2FybmluZycsXG4gICAgJ2xpbnQnLFxuICBdXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVmcyE6IHtcbiAgICBpdGVtcz86IE91dHB1dFBhbmVsSXRlbXNcbiAgfVxuICBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnRzOiBTZXQ8SlNYLkVsZW1lbnQ+ID0gbmV3IFNldCgpXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgcmVhZG9ubHkgdGFiczogTWFwPHN0cmluZywgSUJ0bkRlc2M+ID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgcmVhZG9ubHkgdGFiVXNlcnM6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKClcbiAgcHJpdmF0ZSBpdGVtRmlsdGVyPzogKGl0ZW06IFJlc3VsdEl0ZW0pID0+IGJvb2xlYW5cbiAgcHJpdmF0ZSBjdXJyZW50UmVzdWx0OiBudW1iZXIgPSAwXG4gIHByaXZhdGUgcmVzdWx0cz86IFJlc3VsdHNEQlxuICBwcml2YXRlIGJ1dHRvbnNDbGFzcyE6ICdidXR0b25zLXRvcCcgfCAnYnV0dG9ucy1sZWZ0J1xuICBwcml2YXRlIGJzYz86IEJhY2tlbmRTdGF0dXNDb250cm9sbGVyXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgc3RhdGU6IElTdGF0ZSA9IHsgZmlsZUZpbHRlcjogZmFsc2UsIGFjdGl2ZVRhYjogJ2Vycm9yJyB9LFxuICApIHtcbiAgICB0aGlzLnNldEJ1dHRvbnNDbGFzcyhhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmJ1dHRvbnNQb3NpdGlvbicpKVxuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuICAgIGF0b20uY29uZmlnLm9uRGlkQ2hhbmdlKCdpZGUtaGFza2VsbC5idXR0b25zUG9zaXRpb24nLCAoeyBuZXdWYWx1ZSB9KSA9PiB7XG4gICAgICB0aGlzLnNldEJ1dHRvbnNDbGFzcyhuZXdWYWx1ZSlcbiAgICAgIGhhbmRsZVByb21pc2UodGhpcy51cGRhdGUoKSlcbiAgICB9KVxuXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBPdXRwdXRQYW5lbC5kZWZhdWx0VGFicykge1xuICAgICAgICB0aGlzLnRhYnMuc2V0KG5hbWUsIHtcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIGNvdW50OiAwLFxuICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHRoaXMuYWN0aXZhdGVUYWIobmFtZSksXG4gICAgICAgICAgdXJpRmlsdGVyOiB0cnVlLFxuICAgICAgICAgIGF1dG9TY3JvbGw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20ud29ya3NwYWNlLm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0oKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5maWxlRmlsdGVyKSBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlSXRlbXMoKSlcbiAgICAgIH0pLFxuICAgIClcbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5zaG93KClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykpIHtcbiAgICAgICAgdGhpcy5oaWRlKClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGNvbm5lY3RCc2MoYnNjOiBCYWNrZW5kU3RhdHVzQ29udHJvbGxlcikge1xuICAgIGlmICh0aGlzLmJzYykgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kU3RhdHVzQ29udHJvbGxlciBhbHJlYWR5IGNvbm5lY3RlZCEnKVxuICAgIHRoaXMuYnNjID0gYnNjXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICB0aGlzLmJzYy5vbkRpZFVwZGF0ZSgoKSA9PiBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpKSxcbiAgICApXG5cbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG4gIH1cblxuICBwdWJsaWMgY29ubmVjdFJlc3VsdHMocmVzdWx0czogUmVzdWx0c0RCKSB7XG4gICAgaWYgKHRoaXMucmVzdWx0cykgdGhyb3cgbmV3IEVycm9yKCdSZXN1bHRzIGFscmVhZHkgY29ubmVjdGVkIScpXG4gICAgdGhpcy5yZXN1bHRzID0gcmVzdWx0c1xuXG4gICAgbGV0IGxhc3RVcGRhdGVUaW1lID0gRGF0ZS5ub3coKVxuICAgIGxldCBjb2xsZWN0ZWRTZXZlcml0aWVzID0gbmV3IFNldDxVUEkuVFNldmVyaXR5PigpXG4gICAgY29uc3QgZGlkVXBkYXRlID0gKHNldmVyaXRpZXM6IFVQSS5UU2V2ZXJpdHlbXSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuXG4gICAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlSXRlbXMoKSlcbiAgICAgIGNvbnN0IG5ld1VwZGF0ZVRpbWUgPSBEYXRlLm5vdygpXG4gICAgICBpZiAoXG4gICAgICAgIG5ld1VwZGF0ZVRpbWUgLSBsYXN0VXBkYXRlVGltZSA8XG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuc3dpdGNoVGFiT25DaGVja0ludGVydmFsJylcbiAgICAgICkge1xuICAgICAgICBmb3IgKGNvbnN0IHMgb2Ygc2V2ZXJpdGllcykge1xuICAgICAgICAgIGNvbGxlY3RlZFNldmVyaXRpZXMuYWRkKHMpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbGxlY3RlZFNldmVyaXRpZXMgPSBuZXcgU2V0KHNldmVyaXRpZXMpXG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJlxuICAgICAgICAoIXRoaXMucmVzdWx0cyB8fCB0aGlzLnJlc3VsdHMuaXNFbXB0eShzZXZlcml0aWVzKSlcbiAgICAgICkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihjb2xsZWN0ZWRTZXZlcml0aWVzKVxuICAgICAgfVxuICAgICAgbGFzdFVwZGF0ZVRpbWUgPSBuZXdVcGRhdGVUaW1lXG4gICAgfVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5yZXN1bHRzLm9uRGlkVXBkYXRlKGRpZFVwZGF0ZSkpXG5cbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlKCkpXG4gIH1cblxuICBwdWJsaWMgcmVuZGVyKCkge1xuICAgIGlmICghdGhpcy5yZXN1bHRzKSB7XG4gICAgICByZXR1cm4gPGlkZS1oYXNrZWxsLXBhbmVsIC8+XG4gICAgfVxuICAgIC8vIHRzbGludDpkaXNhYmxlOiBzdHJpY3QtYm9vbGVhbi1leHByZXNzaW9ucyBuby1udWxsLWtleXdvcmRcbiAgICByZXR1cm4gKFxuICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsIGNsYXNzPXt0aGlzLmJ1dHRvbnNDbGFzc30+XG4gICAgICAgIDxpZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICAgIHt0aGlzLmJzYz8ucmVuZGVyU3RhdHVzSWNvbigpIHx8IG51bGx9XG4gICAgICAgICAgPE91dHB1dFBhbmVsQnV0dG9uc1xuICAgICAgICAgICAgYnV0dG9ucz17QXJyYXkuZnJvbSh0aGlzLnRhYnMudmFsdWVzKCkpfVxuICAgICAgICAgICAgYWN0aXZlQnRuPXt0aGlzLnN0YXRlLmFjdGl2ZVRhYn1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbENoZWNrYm94XG4gICAgICAgICAgICBjbGFzcz1cImlkZS1oYXNrZWxsLWNoZWNrYm94LS11cmktZmlsdGVyXCJcbiAgICAgICAgICAgIHN0YXRlPXt0aGlzLnN0YXRlLmZpbGVGaWx0ZXIgfHwgZmFsc2V9XG4gICAgICAgICAgICBvblN3aXRjaGVkPXt0aGlzLnN3aXRjaEZpbGVGaWx0ZXJ9XG4gICAgICAgICAgICBlbmFibGVkSGludD1cIlNob3cgY3VycmVudCBmaWxlIG1lc3NhZ2VzXCJcbiAgICAgICAgICAgIGRpc2FibGVkSGludD1cIlNob3cgYWxsIHByb2plY3QgbWVzc2FnZXNcIlxuICAgICAgICAgIC8+XG4gICAgICAgICAge0FycmF5LmZyb20odGhpcy5lbGVtZW50cy52YWx1ZXMoKSl9XG4gICAgICAgICAge3RoaXMuYnNjPy5yZW5kZXJQcm9ncmVzc0JhcigpIHx8IG51bGx9XG4gICAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgPE91dHB1dFBhbmVsSXRlbXNcbiAgICAgICAgICBtb2RlbD17dGhpcy5yZXN1bHRzfVxuICAgICAgICAgIGZpbHRlcj17dGhpcy5pdGVtRmlsdGVyfVxuICAgICAgICAgIHJlZj1cIml0ZW1zXCJcbiAgICAgICAgLz5cbiAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgKVxuICAgIC8vIHRzbGludDplbmFibGU6IHN0cmljdC1ib29sZWFuLWV4cHJlc3Npb25zIG5vLW51bGwta2V5d29yZFxuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZSgpIHtcbiAgICByZXR1cm4gZXRjaC51cGRhdGUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIHRoaXMuaGlkZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVhbGx5RGVzdHJveSgpIHtcbiAgICBhd2FpdCBldGNoLmRlc3Ryb3kodGhpcylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHRvZ2dsZSgpIHtcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAoIXBhbmUgfHwgKGlzRG9jayhwYW5lKSAmJiAhcGFuZS5pc1Zpc2libGUoKSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnNob3coKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5oaWRlKClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2hvdygpIHtcbiAgICBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKHRoaXMsIHtcbiAgICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlLFxuICAgICAgYWN0aXZhdGVQYW5lOiBmYWxzZSxcbiAgICB9KVxuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmIChwYW5lICYmIGlzRG9jayhwYW5lKSkge1xuICAgICAgcGFuZS5zaG93KClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaGlkZSgpIHtcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAocGFuZSAmJiBpc0RvY2socGFuZSkpIHtcbiAgICAgIGF0b20ud29ya3NwYWNlLmhpZGUodGhpcylcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0VGl0bGUoKSB7XG4gICAgcmV0dXJuICdJREUtSGFza2VsbCdcbiAgfVxuXG4gIHB1YmxpYyBnZXRVUkkoKSB7XG4gICAgcmV0dXJuIGBpZGUtaGFza2VsbDovL291dHB1dC1wYW5lbC9gXG4gIH1cblxuICBwdWJsaWMgZ2V0RGVmYXVsdExvY2F0aW9uKCkge1xuICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnBhbmVsUG9zaXRpb24nKVxuICB9XG5cbiAgcHVibGljIGFkZFBhbmVsQ29udHJvbDxUPihkZWY6IFVQSS5UQ29udHJvbERlZmluaXRpb248VD4pIHtcbiAgICBsZXQgbmV3RWxlbWVudDogSlNYLkVsZW1lbnRcbiAgICBpZiAoaXNTaW1wbGVDb250cm9sRGVmKGRlZikpIHtcbiAgICAgIGNvbnN0IHsgZXZlbnRzLCBjbGFzc2VzLCBzdHlsZSwgYXR0cnMgfSA9IGRlZi5vcHRzXG4gICAgICBjb25zdCBwcm9wczogeyBba2V5OiBzdHJpbmddOiBPYmplY3QgfSA9IHt9XG4gICAgICBpZiAoY2xhc3Nlcykge1xuICAgICAgICBwcm9wcy5jbGFzcyA9IGNsYXNzZXMuam9pbignICcpXG4gICAgICB9XG4gICAgICBpZiAoc3R5bGUpIHtcbiAgICAgICAgcHJvcHMuc3R5bGUgPSBzdHlsZVxuICAgICAgfVxuICAgICAgaWYgKGF0dHJzKSB7XG4gICAgICAgIHByb3BzLmF0dHJpYnV0ZXMgPSBhdHRyc1xuICAgICAgfVxuICAgICAgaWYgKGV2ZW50cykge1xuICAgICAgICBwcm9wcy5vbiA9IGV2ZW50c1xuICAgICAgfVxuXG4gICAgICBuZXdFbGVtZW50ID0gZXRjaC5kb20oZGVmLmVsZW1lbnQsIHByb3BzKVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdFbGVtZW50ID0gZXRjaC5kb20oZGVmLmVsZW1lbnQsIGRlZi5vcHRzKVxuICAgIH1cbiAgICB0aGlzLmVsZW1lbnRzLmFkZChuZXdFbGVtZW50KVxuXG4gICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZSgpKVxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICB0aGlzLmVsZW1lbnRzLmRlbGV0ZShuZXdFbGVtZW50KVxuICAgICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZSgpKVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlSXRlbXMoKSB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICBpZiAodGhpcy5zdGF0ZS5maWxlRmlsdGVyKSB7XG4gICAgICBjb25zdCBlZCA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICAgICAgY3VycmVudFVyaSA9IGVkID8gZWQuZ2V0UGF0aCgpIDogdW5kZWZpbmVkXG4gICAgfVxuICAgIGxldCBzY3JvbGw6IGJvb2xlYW4gPSBmYWxzZVxuICAgIGlmIChhY3RpdmVUYWIpIHtcbiAgICAgIGNvbnN0IGF0byA9IHRoaXMudGFicy5nZXQoYWN0aXZlVGFiKVxuICAgICAgaWYgKGN1cnJlbnRVcmkgIT09IHVuZGVmaW5lZCAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikge1xuICAgICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoeyB1cmksIHNldmVyaXR5IH0pID0+XG4gICAgICAgICAgc2V2ZXJpdHkgPT09IGFjdGl2ZVRhYiAmJiB1cmkgPT09IGN1cnJlbnRVcmlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuaXRlbUZpbHRlciA9ICh7IHNldmVyaXR5IH0pID0+IHNldmVyaXR5ID09PSBhY3RpdmVUYWJcbiAgICAgIH1cbiAgICAgIHNjcm9sbCA9XG4gICAgICAgIChhdG8gJiYgYXRvLmF1dG9TY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zICYmIHRoaXMucmVmcy5pdGVtcy5hdEVuZCgpKSB8fFxuICAgICAgICBmYWxzZVxuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc3VsdHMpIHtcbiAgICAgIGZvciAoY29uc3QgW2J0biwgYXRvXSBvZiB0aGlzLnRhYnMuZW50cmllcygpKSB7XG4gICAgICAgIGF0by5jb3VudCA9IEFycmF5LmZyb20oXG4gICAgICAgICAgdGhpcy5yZXN1bHRzLmZpbHRlcigoeyBzZXZlcml0eSB9KSA9PiBzZXZlcml0eSA9PT0gYnRuKSxcbiAgICAgICAgKS5sZW5ndGhcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnVwZGF0ZSgpXG5cbiAgICBpZiAoc2Nyb2xsICYmIHRoaXMucmVmcy5pdGVtcykgYXdhaXQgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKClcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZVRhYih0YWI6IHN0cmluZykge1xuICAgIHRoaXMuc3RhdGUuYWN0aXZlVGFiID0gdGFiXG4gICAgaGFuZGxlUHJvbWlzZSh0aGlzLnVwZGF0ZUl0ZW1zKCkpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiKHNldmVyaXRpZXM6IFNldDxVUEkuVFNldmVyaXR5Pikge1xuICAgIGZvciAoY29uc3QgdGFiIG9mIHRoaXMudGFicy52YWx1ZXMoKSkge1xuICAgICAgaWYgKCFzZXZlcml0aWVzLmhhcyh0YWIubmFtZSkpIGNvbnRpbnVlXG4gICAgICBjb25zdCBjb3VudCA9IHRhYi5jb3VudFxuICAgICAgaWYgKGNvdW50ICYmIGNvdW50ID4gMCkge1xuICAgICAgICBoYW5kbGVQcm9taXNlKHRoaXMuc2hvdygpKVxuICAgICAgICB0aGlzLmFjdGl2YXRlVGFiKHRhYi5uYW1lKVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93SXRlbShpdGVtOiBSZXN1bHRJdGVtKSB7XG4gICAgdGhpcy5hY3RpdmF0ZVRhYihpdGVtLnNldmVyaXR5KVxuXG4gICAgaWYgKHRoaXMucmVmcy5pdGVtcykgaGFuZGxlUHJvbWlzZSh0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSkpXG4gIH1cblxuICBwdWJsaWMgZ2V0QWN0aXZlVGFiKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLmFjdGl2ZVRhYlxuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZVRhYihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgeyB1cmlGaWx0ZXIgPSB0cnVlLCBhdXRvU2Nyb2xsID0gZmFsc2UgfTogVVBJLklTZXZlcml0eVRhYkRlZmluaXRpb24sXG4gICkge1xuICAgIGlmIChPdXRwdXRQYW5lbC5kZWZhdWx0VGFicy5pbmNsdWRlcyhuYW1lKSkgcmV0dXJuXG4gICAgaWYgKHRoaXMudGFicy5oYXMobmFtZSkpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICB0aGlzLnRhYlVzZXJzLnNldChuYW1lLCB0aGlzLnRhYlVzZXJzLmdldChuYW1lKSEgKyAxKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRhYlVzZXJzLnNldChuYW1lLCAxKVxuICAgICAgdGhpcy50YWJzLnNldChuYW1lLCB7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGNvdW50OiAwLFxuICAgICAgICBvbkNsaWNrOiAoKSA9PiB0aGlzLmFjdGl2YXRlVGFiKG5hbWUpLFxuICAgICAgICB1cmlGaWx0ZXIsXG4gICAgICAgIGF1dG9TY3JvbGwsXG4gICAgICB9KVxuICAgICAgaWYgKHRoaXMuc3RhdGUuYWN0aXZlVGFiKSB0aGlzLmFjdGl2YXRlVGFiKHRoaXMuc3RhdGUuYWN0aXZlVGFiKVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHJlbW92ZVRhYihuYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAoT3V0cHV0UGFuZWwuZGVmYXVsdFRhYnMuaW5jbHVkZXMobmFtZSkpIHJldHVyblxuICAgIGlmICh0aGlzLnRhYlVzZXJzLmhhcyhuYW1lKSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIGxldCBuID0gdGhpcy50YWJVc2Vycy5nZXQobmFtZSkhXG4gICAgICBuIC09IDFcbiAgICAgIGlmIChuID09PSAwKSB7XG4gICAgICAgIHRoaXMudGFiVXNlcnMuZGVsZXRlKG5hbWUpXG4gICAgICAgIHRoaXMudGFicy5kZWxldGUobmFtZSlcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuYWN0aXZlVGFiID09PSBuYW1lKSB7XG4gICAgICAgICAgdGhpcy5zdGF0ZS5hY3RpdmVUYWIgPSBPdXRwdXRQYW5lbC5kZWZhdWx0VGFic1swXVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRhYlVzZXJzLnNldChuYW1lLCBuKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJZGUtSGFza2VsbDogUmVtb3Zpbmcgbm9uZXhpc3RlbnQgb3V0cHV0IHBhbmVsIHRhYiAke25hbWV9YCxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplKCk6IElTdGF0ZSAmIHsgZGVzZXJpYWxpemVyOiAnaWRlLWhhc2tlbGwvT3V0cHV0UGFuZWwnIH0ge1xuICAgIHJldHVybiB7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgZGVzZXJpYWxpemVyOiAnaWRlLWhhc2tlbGwvT3V0cHV0UGFuZWwnLFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzaG93TmV4dEVycm9yKCkge1xuICAgIGlmICghdGhpcy5yZXN1bHRzKSByZXR1cm5cbiAgICBjb25zdCBycyA9IEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcigoeyB1cmkgfSkgPT4gdXJpICE9PSB1bmRlZmluZWQpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHRoaXMuY3VycmVudFJlc3VsdCsrXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA+PSBycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICB9XG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cblxuICBwdWJsaWMgc2hvd1ByZXZFcnJvcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykgcmV0dXJuXG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHsgdXJpIH0pID0+IHVyaSAhPT0gdW5kZWZpbmVkKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQtLVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPCAwKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxXG4gICAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHJpdmF0ZSBzd2l0Y2hGaWxlRmlsdGVyID0gKCkgPT4ge1xuICAgIHRoaXMuc3RhdGUuZmlsZUZpbHRlciA9ICF0aGlzLnN0YXRlLmZpbGVGaWx0ZXJcbiAgICBoYW5kbGVQcm9taXNlKHRoaXMudXBkYXRlSXRlbXMoKSlcbiAgfVxuXG4gIHByaXZhdGUgc2V0QnV0dG9uc0NsYXNzKGJ1dHRvbnNQb3M6ICd0b3AnIHwgJ2xlZnQnKSB7XG4gICAgc3dpdGNoIChidXR0b25zUG9zKSB7XG4gICAgICBjYXNlICd0b3AnOlxuICAgICAgICB0aGlzLmJ1dHRvbnNDbGFzcyA9ICdidXR0b25zLXRvcCdcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ2xlZnQnOlxuICAgICAgICB0aGlzLmJ1dHRvbnNDbGFzcyA9ICdidXR0b25zLWxlZnQnXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9XG59XG4iXX0=