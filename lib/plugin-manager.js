"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
const tooltip_registry_1 = require("./tooltip-registry");
const check_results_provider_1 = require("./check-results-provider");
const status_bar_1 = require("./status-bar");
const prettify_1 = require("./prettify");
const editor_mark_control_1 = require("./editor-mark-control");
const utils_1 = require("./utils");
class PluginManager {
    constructor(state, outputPanel) {
        this.outputPanel = outputPanel;
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.controllers = new Map();
        this.onWillSaveBuffer = (callback) => this.emitter.on('will-save-buffer', callback);
        this.onDidSaveBuffer = (callback) => this.emitter.on('did-save-buffer', callback);
        this.onDidStopChanging = (callback) => this.emitter.on('did-stop-changing', callback);
        this.disposables.add(this.emitter);
        this.resultsDB = new results_db_1.ResultsDB();
        this.outputPanel.connectResults(this.resultsDB);
        this.tooltipRegistry = new tooltip_registry_1.TooltipRegistry(this);
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputPanel, state.configParams);
        this.disposables.add(this.addEditorController(editor_control_1.EditorControl), this.addEditorController(prettify_1.PrettifyEditorController), this.addEditorController(editor_mark_control_1.EditorMarkControl));
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.checkResultsProvider = new check_results_provider_1.CheckResultsProvider(this);
        }
        this.subscribeEditorController();
    }
    deactivate() {
        this.resultsDB.destroy();
        this.disposables.dispose();
        if (this.checkResultsProvider)
            this.checkResultsProvider.destroy();
        utils_1.handlePromise(this.outputPanel.reallyDestroy());
        this.configParamManager.destroy();
        this.removeStatusBar();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            configParams: this.configParamManager.serialize(),
        };
    }
    willSaveBuffer(buffer) {
        return this.emitter.emit('will-save-buffer', buffer);
    }
    didSaveBuffer(buffer) {
        return this.emitter.emit('did-save-buffer', buffer);
    }
    didStopChanging(buffer) {
        return this.emitter.emit('did-stop-changing', buffer);
    }
    togglePanel() {
        utils_1.handlePromise(atom.workspace.toggle(this.outputPanel));
    }
    controller(editor) {
        return this.controllerType(editor_control_1.EditorControl, editor);
    }
    controllerType(factory, editor) {
        const ecmap = this.controllers.get(factory);
        const rec = ecmap ? ecmap.get(editor) : undefined;
        return rec ? rec.controller : undefined;
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.resultsDB);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputPanel.showPrevError();
    }
    backendStatus(pluginName, st) {
        this.outputPanel.backendStatus(pluginName, st);
        if (this.statusBarView) {
            this.statusBarView.backendStatus(pluginName, st);
        }
    }
    addEditorController(factory) {
        if (this.controllers.has(factory)) {
            throw new Error(`Duplicate controller factory ${factory.toString()}`);
        }
        const map = new WeakMap();
        this.controllers.set(factory, map);
        return new atom_1.Disposable(() => {
            this.controllers.delete(factory);
            for (const te of atom.workspace.getTextEditors()) {
                const rec = map.get(te);
                if (rec)
                    rec.disposable.dispose();
            }
        });
    }
    setStatusBar(sb) {
        this.statusBarView = new status_bar_1.StatusBarView(this.outputPanel);
        this.statusBarTile = sb.addRightTile({
            item: this.statusBarView.element,
            priority: 100,
        });
    }
    removeStatusBar() {
        if (this.statusBarTile) {
            this.statusBarTile.destroy();
            this.statusBarTile = undefined;
        }
        if (this.statusBarView) {
            this.statusBarView.destroy();
            this.statusBarView = undefined;
        }
    }
    controllerOnGrammar(editor, grammar) {
        for (const [factory, map] of this.controllers.entries()) {
            const rec = map.get(editor);
            if (!rec && factory.supportsGrammar(grammar.scopeName)) {
                const controller = new factory(editor, this);
                const disposable = new atom_1.CompositeDisposable();
                disposable.add(new atom_1.Disposable(() => {
                    map.delete(editor);
                    controller.destroy();
                }), editor.onDidDestroy(() => disposable.dispose()));
                map.set(editor, { controller, disposable });
            }
            else if (rec && !factory.supportsGrammar(grammar.scopeName)) {
                rec.disposable.dispose();
            }
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            const editorDisp = new atom_1.CompositeDisposable();
            editorDisp.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }), editor.onDidDestroy(() => {
                editorDisp.dispose();
                this.disposables.remove(editorDisp);
            }));
            this.disposables.add(editorDisp);
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFPYTtBQUNiLDZDQUF3QztBQUV4QyxtREFBMkU7QUFDM0UscURBQWdEO0FBQ2hELHFEQUFnRDtBQUNoRCx5REFBb0Q7QUFDcEQscUVBQStEO0FBQy9ELDZDQUE0QztBQUM1Qyx5Q0FBcUQ7QUFDckQsK0RBQXlEO0FBSXpELG1DQUF1QztBQTRCdkMsTUFBYSxhQUFhO0lBcUJ4QixZQUFZLEtBQWEsRUFBUyxXQUF3QjtRQUF4QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQWZsRCxnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN2QyxZQUFPLEdBT1gsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUdULGdCQUFXLEdBQUcsSUFBSSxHQUFHLEVBRzFCLENBQUE7UUE0Q0kscUJBQWdCLEdBQUcsQ0FBQyxRQUFpQyxFQUFFLEVBQUUsQ0FDOUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFFeEMsb0JBQWUsR0FBRyxDQUFDLFFBQWlDLEVBQUUsRUFBRSxDQUM3RCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUV2QyxzQkFBaUIsR0FBRyxDQUFDLFFBQWlDLEVBQUUsRUFBRSxDQUMvRCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQWpEOUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxzQkFBUyxFQUFFLENBQUE7UUFDaEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxD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QUFFLE9BQU8sQ0FBQyxDQUFBO1lBQzNDLENBQUMsQ0FBQyxFQUNGLE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFO2dCQUN2QixVQUFVLENBQUMsT0FBTyxFQUFFLENBQUE7Z0JBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQ3JDLENBQUMsQ0FBQyxDQUNILENBQUE7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUNoQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZELENBQUMsQ0FBQyxDQUNILENBQUE7SUFDSCxDQUFDO0NBQ0Y7QUE5TUQsc0NBOE1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgRW1pdHRlcixcbiAgVGV4dEVkaXRvcixcbiAgVGV4dEJ1ZmZlcixcbiAgR3JhbW1hcixcbiAgRGlzcG9zYWJsZSxcbn0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IFJlc3VsdHNEQiB9IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7IE91dHB1dFBhbmVsLCBJU3RhdGUgYXMgSU91dHB1dFZpZXdTdGF0ZSB9IGZyb20gJy4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHsgQ29uZmlnUGFyYW1NYW5hZ2VyLCBJU3RhdGUgYXMgSVBhcmFtU3RhdGUgfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQgeyBFZGl0b3JDb250cm9sIH0gZnJvbSAnLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7IExpbnRlclN1cHBvcnQgfSBmcm9tICcuL2xpbnRlci1zdXBwb3J0J1xuaW1wb3J0IHsgVG9vbHRpcFJlZ2lzdHJ5IH0gZnJvbSAnLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHsgQ2hlY2tSZXN1bHRzUHJvdmlkZXIgfSBmcm9tICcuL2NoZWNrLXJlc3VsdHMtcHJvdmlkZXInXG5pbXBvcnQgeyBTdGF0dXNCYXJWaWV3IH0gZnJvbSAnLi9zdGF0dXMtYmFyJ1xuaW1wb3J0IHsgUHJldHRpZnlFZGl0b3JDb250cm9sbGVyIH0gZnJvbSAnLi9wcmV0dGlmeSdcbmltcG9ydCB7IEVkaXRvck1hcmtDb250cm9sIH0gZnJvbSAnLi9lZGl0b3ItbWFyay1jb250cm9sJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgKiBhcyBMaW50ZXIgZnJvbSAnYXRvbS9saW50ZXInXG5pbXBvcnQgKiBhcyBTdGF0dXNCYXIgZnJvbSAnYXRvbS9zdGF0dXMtYmFyJ1xuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSB9IGZyb20gJy4vdXRpbHMnXG5cbmV4cG9ydCB7IElQYXJhbVN0YXRlLCBJT3V0cHV0Vmlld1N0YXRlIH1cblxuZXhwb3J0IHR5cGUgVEV2ZW50VHlwZSA9ICdrZXlib2FyZCcgfCAnY29udGV4dCcgfCAnbW91c2UnIHwgJ3NlbGVjdGlvbidcblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBjb25maWdQYXJhbXM6IElQYXJhbVN0YXRlXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVkaXRvckNvbnRyb2xsZXIge1xuICBkZXN0cm95KCk6IHZvaWRcbn1cblxuZXhwb3J0IHR5cGUgSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5ID0gSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5VDxcbiAgSUVkaXRvckNvbnRyb2xsZXJcbj5cblxuZXhwb3J0IGludGVyZmFjZSBJRWRpdG9yQ29udHJvbGxlckZhY3RvcnlUPFQ+IHtcbiAgbmV3IChlZGl0b3I6IFRleHRFZGl0b3IsIG1hbmFnZXI6IFBsdWdpbk1hbmFnZXIpOiBUXG4gIHN1cHBvcnRzR3JhbW1hcihncmFtbWFyOiBzdHJpbmcpOiBib29sZWFuXG59XG5cbmV4cG9ydCB0eXBlIEVDTWFwPFQgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlcj4gPSBXZWFrTWFwPFxuICBUZXh0RWRpdG9yLFxuICB7IGNvbnRyb2xsZXI6IFQ7IGRpc3Bvc2FibGU6IERpc3Bvc2FibGUgfVxuPlxuXG5leHBvcnQgY2xhc3MgUGx1Z2luTWFuYWdlciB7XG4gIHB1YmxpYyByZXN1bHRzREI6IFJlc3VsdHNEQlxuICBwdWJsaWMgY29uZmlnUGFyYW1NYW5hZ2VyOiBDb25maWdQYXJhbU1hbmFnZXJcbiAgcHVibGljIHRvb2x0aXBSZWdpc3RyeTogVG9vbHRpcFJlZ2lzdHJ5XG4gIHByaXZhdGUgY2hlY2tSZXN1bHRzUHJvdmlkZXI/OiBDaGVja1Jlc3VsdHNQcm92aWRlclxuICBwcml2YXRlIGxpbnRlclN1cHBvcnQ/OiBMaW50ZXJTdXBwb3J0XG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgZW1pdHRlcjogRW1pdHRlcjxcbiAgICB7fSxcbiAgICB7XG4gICAgICAnd2lsbC1zYXZlLWJ1ZmZlcic6IFRleHRCdWZmZXJcbiAgICAgICdkaWQtc2F2ZS1idWZmZXInOiBUZXh0QnVmZmVyXG4gICAgICAnZGlkLXN0b3AtY2hhbmdpbmcnOiBUZXh0QnVmZmVyXG4gICAgfVxuICA+ID0gbmV3IEVtaXR0ZXIoKVxuICBwcml2YXRlIHN0YXR1c0JhclRpbGU/OiBTdGF0dXNCYXIuVGlsZVxuICBwcml2YXRlIHN0YXR1c0JhclZpZXc/OiBTdGF0dXNCYXJWaWV3XG4gIHByaXZhdGUgY29udHJvbGxlcnMgPSBuZXcgTWFwPFxuICAgIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeSxcbiAgICBFQ01hcDxJRWRpdG9yQ29udHJvbGxlcj5cbiAgPigpXG4gIGNvbnN0cnVjdG9yKHN0YXRlOiBJU3RhdGUsIHB1YmxpYyBvdXRwdXRQYW5lbDogT3V0cHV0UGFuZWwpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLmVtaXR0ZXIpXG5cbiAgICB0aGlzLnJlc3VsdHNEQiA9IG5ldyBSZXN1bHRzREIoKVxuICAgIHRoaXMub3V0cHV0UGFuZWwuY29ubmVjdFJlc3VsdHModGhpcy5yZXN1bHRzREIpXG4gICAgdGhpcy50b29sdGlwUmVnaXN0cnkgPSBuZXcgVG9vbHRpcFJlZ2lzdHJ5KHRoaXMpXG4gICAgdGhpcy5jb25maWdQYXJhbU1hbmFnZXIgPSBuZXcgQ29uZmlnUGFyYW1NYW5hZ2VyKFxuICAgICAgdGhpcy5vdXRwdXRQYW5lbCxcbiAgICAgIHN0YXRlLmNvbmZpZ1BhcmFtcyxcbiAgICApXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihFZGl0b3JDb250cm9sKSxcbiAgICAgIHRoaXMuYWRkRWRpdG9yQ29udHJvbGxlcihQcmV0dGlmeUVkaXRvckNvbnRyb2xsZXIpLFxuICAgICAgdGhpcy5hZGRFZGl0b3JDb250cm9sbGVyKEVkaXRvck1hcmtDb250cm9sKSxcbiAgICApXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIHRoaXMuY2hlY2tSZXN1bHRzUHJvdmlkZXIgPSBuZXcgQ2hlY2tSZXN1bHRzUHJvdmlkZXIodGhpcylcbiAgICB9XG5cbiAgICB0aGlzLnN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKVxuICB9XG5cbiAgcHVibGljIGRlYWN0aXZhdGUoKSB7XG4gICAgdGhpcy5yZXN1bHRzREIuZGVzdHJveSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICBpZiAodGhpcy5jaGVja1Jlc3VsdHNQcm92aWRlcikgdGhpcy5jaGVja1Jlc3VsdHNQcm92aWRlci5kZXN0cm95KClcblxuICAgIGhhbmRsZVByb21pc2UodGhpcy5vdXRwdXRQYW5lbC5yZWFsbHlEZXN0cm95KCkpXG4gICAgdGhpcy5jb25maWdQYXJhbU1hbmFnZXIuZGVzdHJveSgpXG4gICAgdGhpcy5yZW1vdmVTdGF0dXNCYXIoKVxuICAgIGlmICh0aGlzLmxpbnRlclN1cHBvcnQpIHtcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydC5kZXN0cm95KClcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydCA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUoKTogSVN0YXRlIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29uZmlnUGFyYW1zOiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXJpYWxpemUoKSxcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25XaWxsU2F2ZUJ1ZmZlciA9IChjYWxsYmFjazogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+XG4gICAgdGhpcy5lbWl0dGVyLm9uKCd3aWxsLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG5cbiAgcHVibGljIG9uRGlkU2F2ZUJ1ZmZlciA9IChjYWxsYmFjazogVVBJLlRUZXh0QnVmZmVyQ2FsbGJhY2spID0+XG4gICAgdGhpcy5lbWl0dGVyLm9uKCdkaWQtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcblxuICBwdWJsaWMgb25EaWRTdG9wQ2hhbmdpbmcgPSAoY2FsbGJhY2s6IFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrKSA9PlxuICAgIHRoaXMuZW1pdHRlci5vbignZGlkLXN0b3AtY2hhbmdpbmcnLCBjYWxsYmFjaylcblxuICBwdWJsaWMgd2lsbFNhdmVCdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCd3aWxsLXNhdmUtYnVmZmVyJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIGRpZFNhdmVCdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2F2ZS1idWZmZXInLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgZGlkU3RvcENoYW5naW5nKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXN0b3AtY2hhbmdpbmcnLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgdG9nZ2xlUGFuZWwoKSB7XG4gICAgaGFuZGxlUHJvbWlzZShhdG9tLndvcmtzcGFjZS50b2dnbGUodGhpcy5vdXRwdXRQYW5lbCkpXG4gIH1cblxuICBwdWJsaWMgY29udHJvbGxlcihlZGl0b3I6IFRleHRFZGl0b3IpOiBFZGl0b3JDb250cm9sIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sbGVyVHlwZShFZGl0b3JDb250cm9sLCBlZGl0b3IpXG4gIH1cblxuICBwdWJsaWMgY29udHJvbGxlclR5cGU8XG4gICAgVSBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyLFxuICAgIFQgZXh0ZW5kcyBJRWRpdG9yQ29udHJvbGxlckZhY3RvcnlUPFU+XG4gID4oZmFjdG9yeTogVCwgZWRpdG9yOiBUZXh0RWRpdG9yKTogVSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgZWNtYXAgPSB0aGlzLmNvbnRyb2xsZXJzLmdldChmYWN0b3J5KVxuICAgIGNvbnN0IHJlYyA9IGVjbWFwID8gZWNtYXAuZ2V0KGVkaXRvcikgOiB1bmRlZmluZWRcbiAgICByZXR1cm4gcmVjID8gKHJlYy5jb250cm9sbGVyIGFzIFUpIDogdW5kZWZpbmVkXG4gIH1cblxuICBwdWJsaWMgc2V0TGludGVyKGxpbnRlcjogTGludGVyLkluZGllRGVsZWdhdGUpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdsaW50ZXInKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gbmV3IExpbnRlclN1cHBvcnQobGludGVyLCB0aGlzLnJlc3VsdHNEQilcbiAgfVxuXG4gIHB1YmxpYyBuZXh0RXJyb3IoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICB0aGlzLm91dHB1dFBhbmVsLnNob3dOZXh0RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIHByZXZFcnJvcigpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJykge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHRoaXMub3V0cHV0UGFuZWwuc2hvd1ByZXZFcnJvcigpXG4gIH1cblxuICBwdWJsaWMgYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lOiBzdHJpbmcsIHN0OiBVUEkuSVN0YXR1cykge1xuICAgIHRoaXMub3V0cHV0UGFuZWwuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBzdClcbiAgICBpZiAodGhpcy5zdGF0dXNCYXJWaWV3KSB7XG4gICAgICB0aGlzLnN0YXR1c0JhclZpZXcuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBzdClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYWRkRWRpdG9yQ29udHJvbGxlcjxcbiAgICBVIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXIsXG4gICAgVCBleHRlbmRzIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeVQ8VT5cbiAgPihmYWN0b3J5OiBUKTogRGlzcG9zYWJsZSB7XG4gICAgaWYgKHRoaXMuY29udHJvbGxlcnMuaGFzKGZhY3RvcnkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBjb250cm9sbGVyIGZhY3RvcnkgJHtmYWN0b3J5LnRvU3RyaW5nKCl9YClcbiAgICB9XG4gICAgY29uc3QgbWFwOiBFQ01hcDxVPiA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmNvbnRyb2xsZXJzLnNldChmYWN0b3J5LCBtYXApXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuY29udHJvbGxlcnMuZGVsZXRlKGZhY3RvcnkpXG4gICAgICBmb3IgKGNvbnN0IHRlIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcbiAgICAgICAgY29uc3QgcmVjID0gbWFwLmdldCh0ZSlcbiAgICAgICAgaWYgKHJlYykgcmVjLmRpc3Bvc2FibGUuZGlzcG9zZSgpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyBzZXRTdGF0dXNCYXIoc2I6IFN0YXR1c0Jhci5TdGF0dXNCYXIpIHtcbiAgICB0aGlzLnN0YXR1c0JhclZpZXcgPSBuZXcgU3RhdHVzQmFyVmlldyh0aGlzLm91dHB1dFBhbmVsKVxuICAgIHRoaXMuc3RhdHVzQmFyVGlsZSA9IHNiLmFkZFJpZ2h0VGlsZSh7XG4gICAgICBpdGVtOiB0aGlzLnN0YXR1c0JhclZpZXcuZWxlbWVudCxcbiAgICAgIHByaW9yaXR5OiAxMDAsXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVTdGF0dXNCYXIoKSB7XG4gICAgaWYgKHRoaXMuc3RhdHVzQmFyVGlsZSkge1xuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlLmRlc3Ryb3koKVxuICAgICAgdGhpcy5zdGF0dXNCYXJUaWxlID0gdW5kZWZpbmVkXG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXR1c0JhclZpZXcpIHtcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldy5kZXN0cm95KClcbiAgICAgIHRoaXMuc3RhdHVzQmFyVmlldyA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29udHJvbGxlck9uR3JhbW1hcihlZGl0b3I6IFRleHRFZGl0b3IsIGdyYW1tYXI6IEdyYW1tYXIpIHtcbiAgICBmb3IgKGNvbnN0IFtmYWN0b3J5LCBtYXBdIG9mIHRoaXMuY29udHJvbGxlcnMuZW50cmllcygpKSB7XG4gICAgICBjb25zdCByZWMgPSBtYXAuZ2V0KGVkaXRvcilcbiAgICAgIGlmICghcmVjICYmIGZhY3Rvcnkuc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXIuc2NvcGVOYW1lKSkge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IGZhY3RvcnkoZWRpdG9yLCB0aGlzKVxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICBkaXNwb3NhYmxlLmFkZChcbiAgICAgICAgICBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICAgICAgICBtYXAuZGVsZXRlKGVkaXRvcilcbiAgICAgICAgICAgIGNvbnRyb2xsZXIuZGVzdHJveSgpXG4gICAgICAgICAgfSksXG4gICAgICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSksXG4gICAgICAgIClcbiAgICAgICAgbWFwLnNldChlZGl0b3IsIHsgY29udHJvbGxlciwgZGlzcG9zYWJsZSB9KVxuICAgICAgfSBlbHNlIGlmIChyZWMgJiYgIWZhY3Rvcnkuc3VwcG9ydHNHcmFtbWFyKGdyYW1tYXIuc2NvcGVOYW1lKSkge1xuICAgICAgICByZWMuZGlzcG9zYWJsZS5kaXNwb3NlKClcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBPYnNlcnZlIHRleHQgZWRpdG9ycyB0byBhdHRhY2ggY29udHJvbGxlclxuICBwcml2YXRlIHN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcikgPT4ge1xuICAgICAgICBjb25zdCBlZGl0b3JEaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICBlZGl0b3JEaXNwLmFkZChcbiAgICAgICAgICBlZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBncmFtbWFyKVxuICAgICAgICAgIH0pLFxuICAgICAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgICAgZWRpdG9yRGlzcC5kaXNwb3NlKClcbiAgICAgICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucmVtb3ZlKGVkaXRvckRpc3ApXG4gICAgICAgICAgfSksXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZWRpdG9yRGlzcClcbiAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZWRpdG9yLmdldEdyYW1tYXIoKSlcbiAgICAgIH0pLFxuICAgIClcbiAgfVxufVxuIl19